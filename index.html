<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Evalhalla - Surveys and Evaluations done right | Enquêtes et évaluations bien faites</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" type="text/css"
        rel="stylesheet" media="screen,projection">
    <style>
        nav ul a,
        nav .brand-logo {
            color: #444;
        }

        p {
            line-height: 2rem;
        }

        .sidenav-trigger {
            color: #26a69a;
        }

        .parallax-container {
            min-height: 380px;
            line-height: 0;
            height: auto;
            color: rgba(255, 255, 255, .9);
        }

        .parallax-container .section {
            width: 100%;
        }

        @media only screen and (max-width : 992px) {
            .parallax-container .section {
                position: absolute;
                top: 40%;
            }

            #index-banner .section {
                top: 10%;
            }
        }

        @media only screen and (max-width : 600px) {
            #index-banner .section {
                top: 0;
            }
        }

        .icon-block {
            padding: 0 15px;
        }

        .icon-block .material-icons {
            font-size: inherit;
        }

        footer.page-footer {
            margin: 0;
        }

        nav ul .waves-effect i {
            display: inline;
        }

        nav ul .tab i {
            display: inline;
        }
    </style>
</head>

<body>
    <nav class="white nav-extended" role="navigation" id="root" name="root">
        <div class="nav-wrapper container">
            <a id="logo-container" href="#" class="brand-logo">Evalhalla</a>
            <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            <ul class="right">
                <li>
                    <div class="switch">
                        <label>
                            EN
                            <input class="lang" type="checkbox">
                            <span class="lever"></span>
                            FR
                        </label>
                    </div>
                </li>
            </ul>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li>
                    <a class="waves-effect waves-light btn modal-trigger" href="#modal1">
                        <!--<i class="material-icons">build</i>-->
                        <span class="en">
                            Insert
                        </span>
                        <span class="fr">
                            Adjouter
                        </span>
                    </a>
                </li>
                <li class="hide-on-small-only">
                    <a class="dropdown-trigger" href="#!" data-target="dropdown1">
                        Menu <i class="material-icons right">arrow_drop_down</i>
                    </a>
                </li>
            </ul>
            </ul>
        </div>
    </nav>
    <ul id="dropdown1" class="dropdown-content hide-on-small-only">
        <li>
            <a href="#" class="show_me_how">
                <i class="material-icons">help</i>
                <span class="en">
                    Tutorial
                </span>
                <span class="fr">
                    Explication
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="adm_save_working_survey">
                <i class="material-icons">save</i>
                <span class="en">
                    Save
                </span>
                <span class="fr">
                    Enregistrer
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="survista_send">
                <i class="material-icons">cloud_upload</i>Survista
            </a>
        </li>
        <li><a href="#" class="audit_json_render">
                <i class="material-icons">gavel</i>
                <span class="en">Audit</span><span class="fr">Vérification</span>
            </a>
        </li>
        <li>
            <a href="#" class="adm_clear_ls">
                <i class="material-icons">flip_to_back</i>
                <span class="en">Reset</span><span class="fr">Réinitialiser</span>
            </a>
        </li>
    </ul>
    <ul class="sidenav" id="mobile-demo">
        <!-- Modal Trigger -->
        <li>
            <a class="waves-effect waves-light btn modal-trigger" href="#modal1">
                <!--<i class="material-icons">build</i>-->
                <span class="en">
                    Insert
                </span>
                <span class="fr">
                    Adjouter
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="show_me_how">
                <i class="material-icons">help</i>
                <span class="en">
                    Tutorial
                </span>
                <span class="fr">
                    Explication
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="adm_save_working_survey">
                <i class="material-icons">save</i>
                <span class="en">
                    Save
                </span>
                <span class="fr">
                    Enregistrer
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="survista_send">
                <i class="material-icons">cloud_upload</i> Survista
            </a>
        </li>
        <li>
            <a href="#" class="audit_json_render">
                <i class="material-icons">gavel</i>
                <span class="en">Audit</span><span class="fr">Vérification</span>
            </a>
        </li>
        <li>
            <a href="#" class="adm_clear_ls">
                <i class="material-icons">flip_to_back</i>
                <span class="en">Reset</span><span class="fr">Réinitialiser</span>
            </a>
        </li>
    </ul>

    <div id="editor" name="editor" class="container">
        <div class="section">
            <div class="row">
                <div id="editor_window" class="col s12 m4">
                    <form class="col s12">
                        <div class="row">
                            <div class="input-field col s12">
                                <textarea id="editor_target" class="materialize-textarea"
                                    data-original-height=0></textarea>
                                <label for="editor_target">
                                    <span class="en">
                                        Survey Source (TYPE HERE).
                                    </span>
                                    <span class="fr">
                                        Source d'enquête (TYPE ICI).
                                    </span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div id="render_window" class="col s12 m4">
                    <div class="row">
                        <div id="render_target"></div>
                    </div>
                </div>
                <div id="json_window" class="col s12 m4">
                    <div class="row">
                        <form class="col s12">
                            <div class="input-field col s12">
                                <textarea id="json_target" class="materialize-textarea"
                                    data-original-height=0></textarea>
                                <label for="json_target">
                                    <span class="en">
                                        Survey JSON (auto-generated).
                                    </span>
                                    <span class="fr">
                                        Survey JSON (généré automatiquement).
                                    </span>
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="ls_window" class="col s12 m12">
                    <div class="row">
                        <form class="col s12">
                            <div class="input-field col s12">
                                <h5>
                                    <span class="en">
                                        Local Storage (in browser)
                                    </span>
                                    <span class="fr">
                                        Storage Locale (en browser)
                                    </span>
                                </h5>
                                <div id="ls_target"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="parallax-container valign-wrapper">
        <div class="section no-pad-bot">
            <div class="container">
                <div class="row center">
                    <h5 class="header col s12 light">
                        <span class="en">Evaluate More. Build Less.</span>
                        <span class="fr">Évaluer plus. Construire moins.</span></h5>
                    <h6 class="header col s12 light">
                        <span class="en">
                            Just type to build your survey.
                        </span>
                        <span class="fr">
                            Il suffit de taper pour construire votre enquête.
                        </span>
                    </h6>
                </div>
            </div>
        </div>
        <div class="parallax"><img src="static/images/background3.jpg" alt="Unsplashed background img 3"></div>
    </div>
    <footer class="page-footer teal">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">Evalhalla</h5>
                    <p class="grey-text text-lighten-4">
                        <span class="en">Alpha. Evalhalla is an experiment in making form creation easier.</span>
                        <span class="fr">Alpha. Evalhalla est une expérience visant à faciliter la création de
                            formulaires.</span>
                    </p>
                    <a class="brown-text text-lighten-3" href="http://materializecss.com">Materialize</a>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                <span class="en">Forms that function.</span>
                <span class="fr">Des formes qui fonctionnent.</span>
            </div>
        </div>
    </footer>
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large red">
            <i class="large material-icons">mode_edit</i>
        </a>
        <ul>
            <li><a id="hs_render_window" class="btn-floating red"><i class="material-icons">assignment</i></a></li>
            <li><a id="hs_json_window" class="btn-floating yellow darken-1"><i class="material-icons">code</i></a></li>
            <li><a id="hs_editor_window" class="btn-floating orange darken-1"><i class="material-icons">create</i></a>
            </li>
            <li><a id="hs_ls_window" class="btn-floating green"><i class="material-icons">how_to_vote</i></a></li>
            <li><a class="btn-floating blue" href="#root"><i class="material-icons">arrow_upward</i></a></li>
        </ul>
    </div>
    <!-- Modal Structure -->
    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4><span class="en">+ "Evalese"</span><span class="fr">+ "Evalese"</span></h4>
            <p>

                <span class="en">Use these to quickly insert commands to help you build your survey fast.</span>
                <span class="fr">Utilisez-les pour insérer rapidement des commandes pour votre enquête.</span>
            </p>
            <div class="collection">
                <a href="#!" class="ev-add-header collection-item waves-effect waves-green btn">
                    <span class="en">Add survey header</span>
                    <span class="fr">Ajouter un en-tête d'enquête</span>
                </a>
                <a href="#!" class="ev-add-instr collection-item waves-effect waves-green btn">
                    <span class="en">Add Instruction</span>
                    <span class="fr">Ajouter une instruction</span>
                </a>
                <a href="#!" class="ev-add-qfree collection-item waves-effect waves-green btn">

                    <span class="en">Add Question (Free Text)</span>
                    <span class="fr">Ajouter une question (texte libre)</span>
                </a>
                <a href="#!" class="ev-add-qone collection-item waves-effect waves-green btn">
                    <span class="en">Add Question (Pick One)</span>
                    <span class="fr">Ajouter une question (Choisissez-en une)</span>
                </a>
                <a href="#!" class="ev-add-qany collection-item waves-effect waves-green btn">
                    <span class="en">Add Question (Pick Any)</span>
                    <span class="fr">Ajouter une question (choisir)</span>
                </a>
                <a href="#!" class="ev-add-qscale collection-item waves-effect waves-green btn">
                    <span class="en">Add Question (Scale 1-10)</span>
                    <span class="fr">Ajouter une question (échelle 1-10)</span>
                </a>
                <a href="#!" class="ev-add-qrank collection-item waves-effect waves-green btn">
                    <span class="en">Add Question (Rank/Rate)</span>
                    <span class="fr">Ajouter une question (classement / taux)</span>
                </a>
            </div>
            <hr>
            <a href="#!" class="ev-add-erase waves-effect waves-red btn red darken-2">
                <span class="en">Clear</span>
                <span class="fr">Effacer</span>
            </a>
            <a href="#!" class="modal-close waves-effect waves-green btn">
                <span class="en">Close Editor</span>
                <span class="fr">Fermer Editeur</span>
            </a>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        (function ($) {
            $(function () {
                //
                // EVALHALLA
                //
                // Just type. It will make your form HTML and JSON
                // Think more code less.
                //

                //
                // HTML, JSON, and EVALESE snips
                //

                const g_cmd = {
                    "[SURVEY]": { "type": "survey", "html": "<survey>%v</survey>" },
                    "#": { "type": "survey", "html": "<survey>%v</survey>" },
                    "[TITLE]": { "type": "title", "html": "<title>%v</title>" },
                    "##": { "type": "title", "html": "<title>%v</title>" },
                    "[INTRO]": { "type": "intro", "html": "<intro>%v</intro>" },
                    "###": { "type": "intro", "html": "<intro>%v</intro>" },
                    "[QUESTION]": { "type": "question", "html": "<question>%v</question>" },
                    "Q:": { "type": "question", "html": "<question>%v</question>" },
                    "[SCALE]": { "type": "scale", "html": "<scale>%v</scale>" },
                    "/SCALE": { "type": "scale", "html": "<scale>%v</scale>" },
                    "/ÉCHELLE": { "type": "scale", "html": "<scale>%v</scale>" },
                    "|": { "type": "scale", "html": "<scale>%v</scale>" },
                    "[OPEN]": { "type": "open", "html": "<open>%v</open>" },
                    "/OPEN": { "type": "open", "html": "<open>%v</open>" },
                    "/OUVRIR": { "type": "open", "html": "<open>%v</open>" },
                    "@": { "type": "open", "html": "<open>%v</open>" },
                    "[INSTRUCTION]": { "type": "instruction", "html": "<instruction>%v</instruction>" },
                    "//": { "type": "instruction", "html": "<instruction>%v</instruction>" },
                    "[END]": { "type": "end", "html": "<end>%v</end>" },
                    ";": { "type": "end", "html": "<end>%v</end>" },
                    "[RANDOMORDER]": { "type": "random order", "html": "<rand>%v</rand>" },
                    "~": { "type": "random order", "html": "<rand>%v</rand>" },
                    "/RAND": { "type": "random order", "html": "<rand>%v</rand>" },
                    "[RANDOMIZEORDER]": { "type": "random order", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMORDER]": { "type": "end random order", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMIZEORDER]": { "type": "end random order", "html": "<rand>%v</rand>" },
                    ";~": { "type": "end random order", "html": "<rand>%v</rand>" },
                    ";RAND": { "type": "end random order", "html": "<rand>%v</rand>" },
                    "[RANDOMOPTIONS]": { "type": "random options", "html": "<rand>%v</rand>" },
                    "~~": { "type": "random options", "html": "<rand>%v</rand>" },
                    "/RANDO": { "type": "random options", "html": "<rand>%v</rand>" },
                    "[RANDOMIZEOPTIONS]": { "type": "random options", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMOPTIONS]": { "type": "end random options", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMIZEOPTIONS]": { "type": "end random options", "html": "<rand>%v</rand>" },
                    ";~~": { "type": "end random options", "html": "<rand>%v</rand>" },
                    ";RANDO": { "type": "end random options", "html": "<rand>%v</rand>" },
                    "[PICKONE]": { "type": "pick one", "html": "<pick>%v</pick>" },
                    "/ONE": { "type": "pick one", "html": "<pick>%v</pick>" },
                    "/UN": { "type": "pick one", "html": "<pick>%v</pick>" },
                    ".": { "type": "pick one", "html": "<pick>%v</pick>" },
                    "[PICKANY]": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "/ANY": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "/TOUT": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "*": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "[ENDPICK]": { "type": "end pick", "html": "<pick>%v</pick>" },
                    "[RANK]": { "type": "rank", "html": "<rank>%v</rank>" },
                    "/RANK": { "type": "rank", "html": "<rank>%v</rank>" },
                    "/TAUX": { "type": "rank", "html": "<rank>%v</rank>" },
                    "$": { "type": "rank", "html": "<rank>%v</rank>" },
                    "[RATE]": { "type": "rank", "html": "<rank>%v</rank>" },
                    "/RATE": { "type": "rank", "html": "<rank>%v</rank>" },
                    "[ENDRANK]": { "type": "end rank", "html": "<rank>%v</rank>" },
                    "[ENDRATE]": { "type": "end rank", "html": "<rank>%v</rank>" }
                };
                const g_intro_script = "" +
                    "# 123\n" +
                    "## Evalhalla Survey\n" +
                    "### It's easy to make a survey. \n" +
                    "\n" +
                    "Q: Have you clicked on 'tutorial' yet?\n" +
                    "/ONE\n" +
                    "Yes\n" +
                    "No\n" +
                    ";\n" +
                    "\n" +
                    "// Thanks\n" +
                    "";
                const g_intro_script_fr = "" +
                    "# 123\n" +
                    "## Enquête Evalhalla \n" +
                    "### Il est facile de faire une enquête. \n" +
                    "\n" +
                    "Q: Avez-vous déjà cliqué sur 'tutorial'?\n" +
                    "/UN\n" +
                    "Oui\n" +
                    "Non\n" +
                    ";\n" +
                    "\n" +
                    "// Merci!\n" +
                    "";
                const g_tutorial_script = "" +
                    "[SURVEY] 1234 \n" +
                    "[TITLE] This is my title \n" +
                    "[INTRO] This is a cool survey, you should fill it out. \n" +
                    "\n" +
                    "[QUESTION] How about them apples \n" +
                    "[PICKONE] \n" +
                    "Red \n" +
                    "Green \n" +
                    "Gala \n" +
                    "[END] \n" +
                    "\n" +
                    "[QUESTION] How cool was that ? \n" +
                    "[SCALE] Meh, Cool! , Unsure \n" +
                    "\n" +
                    "[INSTRUCTION] 3 is good 1 is bad \n" +
                    "[QUESTION] Rate the following from 1 to 3 \n" +
                    "[RATE] \n" +
                    "Apples \n" +
                    "Oranges \n" +
                    "[END] \n" +
                    "\n" +
                    "[QUESTION] Ok, you in right ? \n" +
                    "[PICKANY] \n" +
                    "Yes \n" +
                    "YUSSSS \n" +
                    "OMG \n" +
                    "[END] \n" +
                    "\n" +
                    "[QUESTION] Parting thoughts ? \n" +
                    "[OPEN] \n" +
                    "\n" +
                    "[INSTRUCTION] Thank you!\n";
                var g_shorthand_script = "" +
                    "# 1234 \n" +
                    "## This is my title \n" +
                    "### This is a cool survey, you should fill it out. \n" +
                    "\n" +
                    "Q: How about them apples \n" +
                    "/ONE \n" +
                    "Red \n" +
                    "Green \n" +
                    "Gala \n" +
                    "; \n" +
                    "\n" +
                    "Q: How cool was that ? \n" +
                    "/SCALE Meh, Cool! , Unsure \n" +
                    "\n" +
                    "// 3 is good 1 is bad \n" +
                    "Q: Rate the following from 1 to 3 \n" +
                    "/RATE \n" +
                    "Apples \n" +
                    "Oranges \n" +
                    "; \n" +
                    "\n" +
                    "Q: Ok, you in right ? \n" +
                    "/ANY \n" +
                    "Yes \n" +
                    "YUSSSS \n" +
                    "OMG \n" +
                    "; \n" +
                    "\n" +
                    "Q: Parting thoughts ? \n" +
                    "/OPEN \n" +
                    "\n" +
                    "// Thank you!\n" +
                    "";
                var g_shorthand_script_fr = "" +
                    "# 1234\n" +
                    "## c'est mon titre\n" +
                    "### Ceci est une bonne enquête, vous devriez le remplir.\n" +
                    "\n" +
                    "Q: Et les pommes\n" +
                    "/UN\n" +
                    "rouge\n" +
                    "vert\n" +
                    "Gala\n" +
                    "; \n" +
                    "\n" +
                    "Q: Comment était-ce cool?\n" +
                    "/ÉCHELLE Meh, Cool! , Incertain\n" +
                    "\n" +
                    "// 3 est bon 1 est mauvais\n" +
                    "Q: Évaluez ce qui suit de 1 à 3\n" +
                    "/TAUX\n" +
                    "Pommes\n" +
                    "Des oranges\n" +
                    "; \n" +
                    "\n" +
                    "Q: Ok, vous avez raison?\n" +
                    "/TOUT\n" +
                    "Oui\n" +
                    "YUSSSS\n" +
                    "OMG\n" +
                    "; \n" +
                    "\n" +
                    "Q: pensées de séparation?\n" +
                    "/OUVRIR\n" +
                    "\n" +
                    "// Merci!\n" +
                    "";
                // Je vous remercie!
                var form_wrap = function (src) {
                    return '' +
                        '<form id="evalhalla_form" action="#">' +
                        src +
                        '<div class="row">' +
                        '<div class="col s12 center">' +
                        '<a id="evalhalla_submit" class="waves-effect waves-light btn"><i class="material-icons right">cloud</i><span class="en">SUBMIT</span><span class="fr">PROVIR</span></a>' +
                        '</div>' +
                        '</div>' +
                        '</form>' +
                        '';
                };
                var get_template_snip = function (snip, format = "html") {
                    if (snip == "header") {
                        if (format == "json") {
                            return '{' +
                                '"title": "%title",' +
                                '"description": "%intro",' +
                                '"language": "%lang",' +
                                '"questions": [%questions]' +
                                '}';
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="col s12 center">' +
                            '<h3><i class="mdi-content-send brown-text"></i></h3>' +
                            '<h4>%title (%survey)</h4>' +
                            '<p class="flow-text left-align light">%intro</p>' +
                            '</div>' +
                            '</div>';
                    } else if (snip == "question") {
                        if (format == "json") {
                            return '{' +
                                '"qid": "%qid",' +
                                '"question": "%question",' +
                                '"description": "%question",' +
                                '"language": "%lang",' + // en or fr
                                '"questionType": "%type",' + //mcq 'text' , 'dropdown',
                                '"randomOrder": "%rand_order",' +
                                '"randomOptions": "%rand_options",' +
                                '"options": [%options]' +
                                '}';
                        }
                        return '' +
                            '<div class="card-panel">' +
                            '<blockquote><span class="badge" style="font-size:1.5em;"><strong>#%qid</strong></span> %question</blockquote>%form' +
                            '</div>' +
                            '';
                    } else if (snip == "scale") {
                        if (format == "json") {
                            return '"1 %low",' +
                                '"2",' +
                                '"3",' +
                                '"4",' +
                                '"5",' +
                                '"6",' +
                                '"7",' +
                                '"8",' +
                                '"9",' +
                                '"10 %high",' +
                                '"%unsure"';
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="input-field col s12" >' +
                            '<select id="scale_qid_%qid" name="scale_qid_%qid">' +
                            '<option value="" disabled selected>--</option>' +
                            '<option value="1">1 %low</option>' +
                            '<option value="2">2</option>' +
                            '<option value="3">3</option>' +
                            '<option value="4">4</option>' +
                            '<option value="5">5</option>' +
                            '<option value="6">6</option>' +
                            '<option value="7">7</option>' +
                            '<option value="8">8</option>' +
                            '<option value="9">9</option>' +
                            '<option value="10">10 %high</option>' +
                            '<option value="77">%unsure</option>' +
                            '</select>' +
                            '<label><span class="en">Choose your rating</span><span class="fr">Chosir s.v.p.</span></label>' +
                            '</div> ' +
                            '</div> ' +
                            '';
                    } else if (snip == "open") {
                        if (format == "json") {
                            return "";
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="row">' +
                            '<div class="input-field col s12">' +
                            '<label for="textarea_qid_%qid"><span class="en">Enter your answer</span><span class="fr">Provir votre reponse</span></label>' +
                            '<textarea id="textarea_qid_%qid" name="textarea_qid_%qid" class="materialize-textarea"></textarea>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '';
                    } else if (snip == "pick one") {
                        if (format == "json") {
                            return '"%pick"';
                        }
                        return '' +
                            '<div class="row">' +
                            '<label>' +
                            '<input class="with-gap" name="rgroup_qid_%qid" type="radio" value="%pick" />' +
                            '<span>%pick</span>' +
                            '</label>' +
                            '</div>' +
                            '';
                    } else if (snip == "pick any") {
                        if (format == "json") {
                            return '"%pick"';
                        }
                        return '' +
                            '<div class="row">' +
                            '<label>' +
                            '<input name="cgroup_qid_%qid[]" type="checkbox" value="%pick" />' +
                            '<span>%pick</span>' +
                            '</label>' +
                            '</div>' +
                            '';
                    } else if (snip == "rank") {
                        if (format == "json") {
                            return '"%pick"';
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="col s12">' +
                            '<div class="input-field s12">' +
                            '<input id="inline_qid_%qid" name="inline_qid_%qid_oid_%oid" type="text">' +
                            '<label for="inline_qid_%qid">%pick</label>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '';
                    } else if (snip == "instruction") {
                        if (format == "json") {
                            return '{' +
                                '"qid": "none",' +
                                '"question": "%instruction",' +
                                '"description": "%instruction",' +
                                '"language": "%lang",' + // en or fr
                                '"questionType": "instruction",' + //mcq 'text' , 'dropdown',
                                '"randomOrder": "%rand_order",' +
                                '"randomOptions": "%rand_options",' +
                                '"options": []' +
                                '}';
                        }
                        return '' +
                            '<div class="card-panel">' +
                            '<span class="blue-text text-darken-2">%instruction</span>' +
                            '</div>' +
                            '';
                    } else if (snip == "ls") {
                        return '' +
                            '<table class="highlight responsive-table">' +
                            '<thead>' +
                            '<tr>' +
                            '<th><span class="en">Survey</span><span class="fr">Enquête</span></th>' +
                            '<th><span class="en">Details</span><span class="fr">Details</span></th>' +
                            '<th><span class="en">Lang</span><span class="fr">Lang</span></th>' +
                            '<th><span class="en">Items</span><span class="fr">Articles</span></th>' +
                            '</tr>' +
                            '</thead>' +
                            '<tbody>' +
                            '%tbody' +
                            '</tbody>' +
                            '</table>' +
                            '';
                    }

                    return "";
                };

                //
                // LocalStorage for client side info store
                //
                var ls_storageAvailable = function (type) {
                    var storage;
                    try {
                        storage = window[type];
                        var x = '__storage_test__';
                        storage.setItem(x, x);
                        storage.removeItem(x);
                        return true;
                    }
                    catch (e) {
                        return e instanceof DOMException && (
                            // everything except Firefox
                            e.code === 22 ||
                            // Firefox
                            e.code === 1014 ||
                            // test name field too, because code might not be present
                            // everything except Firefox
                            e.name === 'QuotaExceededError' ||
                            // Firefox
                            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
                            // acknowledge QuotaExceededError only if there's something already stored
                            (storage && storage.length !== 0);
                    }
                }

                var warn_user_no_storage = false;
                var warn_user_alert = function () {
                    // Too bad, no localStorage for us
                    if (warn_user_no_storage == false) {
                        alert("This device does not support local storage. Save feature disabled.");
                        warn_user_no_storage = true;
                    }
                }
                var ls_show_local_storage = function () {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        var display_str = "";
                        var tbody = "";

                        display_str += '<nav><div class="nav-wrapper"><div class="col s12"><span class="en">Working Survey</span><span class="fr">Enquête en cours</span></div></div></nav>';
                        display_str += get_template_snip("ls");
                        tbody = "";
                        if (ev_ls["working_survey"] != null) {
                            tbody += "<tr><td>" +
                                (ev_ls["working_survey"]["title"] != null ? ev_ls["working_survey"]["title"] : "") +
                                "</td><td>" +
                                (ev_ls["working_survey"]["description"] != null ? ev_ls["working_survey"]["description"] : "") +
                                "</td><td>" +
                                (ev_ls["working_survey"]["language"] != null ? ev_ls["working_survey"]["language"] : "") +
                                "</td><td>" +
                                (ev_ls["working_survey"]["questions"] != null ? ev_ls["working_survey"]["questions"].length : "") +
                                "</td><tr>" +
                                "";
                        } else {
                            tbody = "<tr><td>None</td><td></td><td></td><td></td>";
                        }
                        display_str = display_str.replace(/\%tbody/g, tbody);

                        display_str += '<nav><div class="nav-wrapper"><div class="col s12"><span class="en">Saved Surveys</span><span class="fr">Enquête Sauvegardées</span> (%count)</div></div></nav>';
                        display_str += get_template_snip("ls");
                        tbody = "";
                        if (ev_ls["saved_survey_signatures"] != null
                            && ev_ls["saved_survey_signatures"].length > 0) {
                            display_str = display_str.replace(/\%count/g, ev_ls["saved_survey_signatures"].length);
                            var cs = null;
                            for (var l = 0; l < ev_ls["saved_survey_signatures"].length; l++) {
                                cs = ev_ls["saved_survey_signatures"][l]["survista"];
                                tbody += '<tr><td><a href="#" id="sv_sr_' + l + '" class="adm_load_survey">' +
                                    (cs["title"] != null ? cs["title"] : "") +
                                    "</a></td><td>" +
                                    (cs["description"] != null ? cs["description"] : "") +
                                    "</td><td>" +
                                    (cs["language"] != null ? cs["language"] : "") +
                                    "</td><td>" +
                                    (cs["questions"] != null ? cs["questions"].length : "") +
                                    "</td><tr>" +
                                    "";
                            }
                        } else {
                            tbody = "<tr><td>-</td><td></td><td></td><td></td>";
                        }
                        display_str = display_str.replace(/\%count/g, "0");
                        display_str = display_str.replace(/\%tbody/g, tbody);

                        display_str += '<nav><div class="nav-wrapper"><div class="col s12"><span class="en">Saved Responses</span><span class="fr">Réponses Sauvegardées</span> (%count)</h6></div></div></nav>';
                        display_str += get_template_snip("ls");
                        tbody = "";
                        if (ev_ls["saved_filled_survey_responses"] != null && ev_ls["saved_filled_survey_responses"].length > 0) {
                            display_str = display_str.replace(/\%count/g, ev_ls["saved_filled_survey_responses"].length);
                            for (var l = 0; l < ev_ls["saved_filled_survey_responses"].length; l++) {
                                tbody += "<tr><td>" +
                                    ev_ls["saved_filled_survey_responses"][l]["survey"]["title"] +
                                    "</td><td>" +
                                    JSON.stringify(ev_ls["saved_filled_survey_responses"][l]["response"], null, 4) +
                                    "</td><td>" +
                                    "-</td><td>" +
                                    "-</td><tr>" +
                                    "";
                            }
                        } else {
                            tbody = "<tr><td>-</td><td></td><td></td><td></td>";
                        }
                        display_str = display_str.replace(/\%count/g, "0");
                        display_str = display_str.replace(/\%tbody/g, tbody);

                        g_state["el"]["c_ls"].html("" +
                            display_str +
                            ""
                        );
                        $(".adm_load_survey").on("click", function () {
                            ls_load_survey($(this).attr("id"), "sv_sr_");
                        });
                        refresh_lang();
                        ui_resize_textareas();
                    } else {
                        warn_user_alert();
                    }
                }
                var ls_load_survey = function (id, trim) {
                    if (ls_storageAvailable('localStorage')) {
                        var ls_index = parseInt(id.replace(trim, ""), 10);
                        var ev_ls = ls_get_lsobject();

                        g_state["el"]["c_editor"].val(
                            ev_ls["saved_survey_signatures"][ls_index]["evalhalla"]
                        );

                        g_state["el"]["c_editor"].trigger("change");
                    } else {
                        warn_user_alert();
                    }
                }
                var ls_clear_saved_entries = function () {
                    if (ls_storageAvailable('localStorage')) {
                        localStorage.clear();
                        ls_init_local_storage();
                        g_state["el"]["c_editor"].trigger("change");
                        ls_show_local_storage();
                    } else {
                        warn_user_alert();
                    }
                }
                /*
                ev_ls = {
                    "working_survey": "", // json source curr survey
                    "saved_survey_signature": [{"survista":{}, "evalhalla": ""}], // array of json src
                    "saved_filled_survey_responses": [{},{}], //array of answerjson + survey sig
                }
                */
                var ls_init_local_storage = function () {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = {
                            "working_survey": {}, // json source curr survey
                            "saved_survey_signatures": [], // array of json src
                            "saved_filled_survey_responses": [], //array of answerjson + survey sig
                        };
                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                    } else {
                        warn_user_alert();
                    }
                }
                var ls_get_lsobject = function () {
                    var ev_ls = localStorage.getItem('ev_ls');
                    if (ev_ls == null) {
                        ls_init_local_storage();
                        ev_ls = localStorage.getItem('ev_ls');
                    }
                    ev_ls = JSON.parse(ev_ls);
                    return ev_ls;
                }
                var ls_save_survey_signature = function (signature, src) {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        //console.log(ev_ls);
                        ev_ls["saved_survey_signatures"].push({ "survista": JSON.parse(signature), "evalhalla": src });
                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                        ls_show_local_storage();
                        ui_resize_textareas();
                    } else {
                        warn_user_alert();
                    }
                }
                var ls_update_working_survey = function (signature) {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        ev_ls["working_survey"] = JSON.parse(signature);
                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                        ls_show_local_storage();
                        ui_resize_textareas();
                    } else {
                        warn_user_alert();
                    }
                }
                var ls_save_survey_response = function (response) {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();

                        ev_ls["saved_filled_survey_responses"].push(
                            {
                                "response": JSON.parse(response),
                                "survey": ev_ls["working_survey"]
                            }
                        );

                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                        ls_show_local_storage();
                        ui_resize_textareas();
                        alert("Thank you!");
                    } else {
                        warn_user_alert();
                    }
                }
                var ls_view_saved_entries = function () {
                    if (ls_storageAvailable('localStorage')) {
                        ls_show_local_storage();
                    } else {
                        warn_user_alert();
                    }
                }

                //
                // State Controls
                //

                // app state details, ui, handle to jq elems
                const g_state = {
                    "tut": {
                        "type_it": g_tutorial_script.split(""),
                        "type_it_short": g_shorthand_script.split(""),
                        "type_it_short_fr": g_shorthand_script_fr.split(""),
                        "char_at": 0,
                        "typer": null,
                    },
                    "ui": {
                        "lang": "en",
                        "hs_editor_window": false,
                        "hs_json_window": false,
                        "hs_render_window": false,
                        "hs_ls_window": false
                    },
                    "el": {
                        // lang
                        "lang": $(".lang"),
                        "en": $(".en"),
                        "fr": $(".fr"),
                        // buttons
                        "btn_upload": $(".survista_send"),
                        "btn_tutorial": $(".show_me_how"),
                        "btn_tutorial_short": $(".show_me_how_short"),
                        "btn_hs_editor": $("#hs_editor_window"),
                        "btn_hs_json": $("#hs_json_window"),
                        "btn_hs_render": $("#hs_render_window"),
                        "btn_hs_ls": $("#hs_ls_window"),
                        "btn_audit": $(".audit_json_render"),
                        // admin buttons
                        "adm_clear_ls": $(".adm_clear_ls"),
                        "adm_save_working_survey": $(".adm_save_working_survey"),
                        // add cmms editor
                        "edt_erase": $(".ev-add-erase"),
                        "edt_header": $(".ev-add-header"),
                        "edt_instr": $(".ev-add-instr"),
                        "edt_qany": $(".ev-add-qany"),
                        "edt_qfree": $(".ev-add-qfree"),
                        "edt_qone": $(".ev-add-qone"),
                        "edt_qrank": $(".ev-add-qrank"),
                        "edt_qscale": $(".ev-add-qscale"),

                        // content
                        "c_editor": $("#editor_target"),
                        "c_json": $("#json_target"),
                        "c_render": $("#render_target"),
                        "c_ls": $("#ls_target"),
                        // ui panels
                        "ui_editor": $("#editor_window"),
                        "ui_json": $("#json_window"),
                        "ui_render": $("#render_window"),
                        "ui_ls": $("#ls_window")
                    }
                };
                // parser state, headers, questions, json
                var g_control_flags = {
                    "json": "{}",
                    "header": {
                        "survey": false,
                        "title": false,
                        "intro": false
                    },
                    "question": {
                        "text": false,
                        "qid": 0,
                        "form": false,
                        "random": {
                            "order": false,
                            "options": false
                        }
                    }
                }
                var reset_control_flags = function (hard = false) {
                    g_control_flags["question"] = {
                        "text": false,
                        "qid": 0,
                        "form": false,
                        "random": {
                            "order": false,
                            "options": false
                        }
                    };
                    g_control_flags["json"] = "{}";
                    if (hard == true) {
                        g_control_flags["header"] = {
                            "survey": "",
                            "title": "",
                            "intro": ""
                        };
                    }
                }

                //
                // Helper functions
                //

                const shuffle_array = function (array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                };

                const get_params_as_object = function (query) {
                    query = query.substring(query.indexOf('?') + 1);
                    var re = /([^&=]+)=?([^&]*)/g;
                    var decodeRE = /\+/g;

                    var decode = function (str) {
                        return decodeURIComponent(str.replace(decodeRE, " "));
                    };

                    var params = {}, e;
                    while (e = re.exec(query)) {
                        var k = decode(e[1]), v = decode(e[2]);
                        if (k.substring(k.length - 2) === '[]') {
                            k = k.substring(0, k.length - 2);
                            (params[k] || (params[k] = [])).push(v);
                        }
                        else params[k] = v;
                    }

                    var assign = function (obj, keyPath, value) {
                        var lastKeyIndex = keyPath.length - 1;
                        for (var i = 0; i < lastKeyIndex; ++i) {
                            var key = keyPath[i];
                            if (!(key in obj))
                                obj[key] = {}
                            obj = obj[key];
                        }
                        obj[keyPath[lastKeyIndex]] = value;
                    }

                    for (var prop in params) {
                        var structure = prop.split('[');
                        if (structure.length > 1) {
                            var levels = [];
                            structure.forEach(function (item, i) {
                                var key = item.replace(/[?[\]\\ ]/g, '');
                                levels.push(key);
                            });
                            assign(params, levels, params[prop]);
                            delete (params[prop]);
                        }
                    }
                    return params;
                };

                const evalhalla_submit = function () {
                    // make some form data
                    var formElement = document.getElementById("evalhalla_form");
                    var formData = new FormData(formElement);
                    console.log(formData);
                    // can use that to post
                    // query string would be
                    var query_string = $("#evalhalla_form").serialize();
                    console.log(query_string);
                    // let em know
                    var json_o = get_params_as_object(query_string);
                    var json_o_string = (JSON.stringify(json_o, null, 4));
                    // save response to local storage
                    ls_save_survey_response(json_o_string);
                    // show local storage items
                    ls_view_saved_entries();
                    //alert(json_o_string);
                    //alert("Check the console for details");
                };

                const pack_text = function (src_a, i, pack, join = " ") {
                    var nextcmd = "null";
                    while (nextcmd == "null") {
                        if (i + 1 < src_a.length) {
                            nextcmd = detect_command(src_a[i + 1]);
                            if (nextcmd == "null") {
                                pack += join + src_a[i + 1];
                                i++;
                            } else {
                                // do nothing
                            }
                        } else {
                            nextcmd = "exit";
                        }
                    }
                    return { "pack": pack, "i": i };
                }

                var ui_resize_textareas = function () {
                    M.textareaAutoResize(g_state["el"]["c_editor"]);
                    M.textareaAutoResize(g_state["el"]["c_json"]);
                }

                //
                // Command Handlers
                //

                var detect_command = function (src) {
                    var first_word = src.split(" ")[0];
                    if (first_word == "" || typeof first_word === "undefined") {
                        return "null";
                    } else if (first_word == "\n") {
                        return "newline";
                    } else if (typeof g_cmd[first_word.toUpperCase().trim()] !== "undefined") {
                        return g_cmd[first_word.toUpperCase().trim()];
                    }
                    return "null";
                }
                var handle_cmd_header = function (cmd, src) {
                    g_control_flags["header"][cmd] = src.replace(src.split(" ")[0], "").trim();
                    // handle html
                    var snip = get_template_snip("header");
                    snip = snip.replace(/\%title/g, g_control_flags["header"]["title"]);
                    snip = snip.replace(/\%survey/g, g_control_flags["header"]["survey"]);
                    snip = snip.replace(/\%intro/g, g_control_flags["header"]["intro"]);
                    reset_control_flags();
                    // handle json
                    var jsonsnip = get_template_snip("header", "json");
                    jsonsnip = jsonsnip.replace(/\%title/g, g_control_flags["header"]["title"]);
                    jsonsnip = jsonsnip.replace(/\%survey/g, g_control_flags["header"]["survey"]);
                    jsonsnip = jsonsnip.replace(/\%intro/g, g_control_flags["header"]["intro"]);
                    g_control_flags["json"] = jsonsnip;

                    return snip;
                }
                var handle_cmd_instruction = function (cmd, src) {
                    // handle html
                    var snip = get_template_snip("instruction");
                    snip = snip.replace(/\%instruction/g, src.replace(src.split(" ")[0], "").trim());
                    // handle json
                    var jsonsnip = get_template_snip("instruction", "json");
                    jsonsnip = jsonsnip.replace(/\%instruction/g, src.replace(src.split(" ")[0], "").trim());
                    g_control_flags["json"] = g_control_flags["json"]
                        .replace("%questions", jsonsnip + ",%questions")
                        .replace("%rand_order", g_control_flags["question"]["random"]["order"])
                        .replace("%rand_options", g_control_flags["question"]["random"]["options"])
                        .replace("%lang", g_state["ui"]["lang"])
                        ;
                    return snip;
                }
                var handle_cmd_question = function (cmd, src) {
                    var snip = get_template_snip("question");
                    if (cmd == "question") {
                        // handle html
                        g_control_flags["question"]["text"] = src.replace(src.split(" ")[0], "").trim();
                        g_control_flags["question"]["qid"] = g_control_flags["question"]["qid"] + 1;
                        snip = snip.replace(/\%question/g, g_control_flags["question"]["text"]);
                        snip = snip.replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        g_control_flags["question"]["form"] = snip;
                        // handle json
                        var jsonsnip = get_template_snip("question", "json");
                        jsonsnip = jsonsnip.replace(/\%question/g, g_control_flags["question"]["text"]);
                        jsonsnip = jsonsnip.replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        g_control_flags["json"] = g_control_flags["json"]
                            .replace("%questions", jsonsnip + ",%questions")
                            .replace("%rand_order", g_control_flags["question"]["random"]["order"])
                            .replace("%rand_options", g_control_flags["question"]["random"]["options"])
                            ;
                    } else if (cmd == "scale") {
                        // handle html
                        snip = g_control_flags["question"]["form"];
                        var scale = get_template_snip("scale").replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        var opts = src.split(",")
                        // clean opts
                        opts[0] = opts[0]
                            .replace("[SCALE]", "")
                            .replace(/(\/SCALE|\/scale)/g, "")
                            .replace(/(\/ÉCHELLE|\/échelle)/g, "")
                            .replace("|", "")
                            .trim();
                        // handle json
                        var jsonsnip = get_template_snip("scale", "json");
                        jsonsnip = jsonsnip.replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        g_control_flags["json"] = g_control_flags["json"].replace(/\%type/g, "dropdown");

                        for (var opti = 0; opti < opts.length; opti++) {
                            if (opti == 0) {
                                scale = scale.replace(/\%low/g, opts[opti]);
                                jsonsnip = jsonsnip.replace(/\%low/g, opts[opti].trim());
                            } else if (opti == 1) {
                                scale = scale.replace(/\%high/g, opts[opti]);
                                jsonsnip = jsonsnip.replace(/\%high/g, opts[opti].trim());
                            } else if (opti == 2) {
                                scale = scale.replace(/\%unsure/g, opts[opti]);
                                jsonsnip = jsonsnip.replace(/\%unsure/g, opts[opti].trim());
                            }
                            else {
                                // do nothing
                            }
                        }
                        // cleanup unused replacement symbol targets
                        scale = scale.replace(/\%low/g, "")
                            .replace(/\%high/g, "")
                            .replace(/\%unsure/g, "");
                        jsonsnip = jsonsnip.replace(/\%low/g, "")
                            .replace(/\%high/g, "")
                            .replace(/\%unsure/g, "");

                        g_control_flags["json"] = g_control_flags["json"].replace("%options", jsonsnip);
                        snip = snip.replace(/\%form/g, scale);
                        g_control_flags["question"]["form"] = snip;
                    } else if (cmd == "open") {
                        // handle html
                        snip = g_control_flags["question"]["form"];
                        snip = snip.replace(/\%form/g, get_template_snip("open").replace(/\%qid/g, g_control_flags["question"]["qid"]));
                        g_control_flags["question"]["form"] = snip;
                        // handle json
                        g_control_flags["json"] = g_control_flags["json"].replace("%options", "").replace(/\%type/g, "text");
                    } else if (cmd == "pick one" || cmd == "pick any" || cmd == "rank") {
                        snip = g_control_flags["question"]["form"];
                        var opts = src.split("[OPT]")
                        opts.shift(); // remove first null item
                        var form = "";
                        var jsonsnip = '';
                        // handle html+json same time
                        var random_shuffle = [];
                        var temp_snip = "";
                        for (var opti = 0; opti < opts.length; opti++) {
                            temp_snip = get_template_snip(cmd)
                                .replace(/\%qid/g, g_control_flags["question"]["qid"])
                                .replace(/\%pick/g, opts[opti].trim())
                                .replace(/\%oid/g, opti)
                                ;
                            form += temp_snip;
                            random_shuffle.push(temp_snip);

                            jsonsnip += "," + get_template_snip(cmd, "json")
                                .replace(/\%pick/g, opts[opti].trim());
                        }
                        if (g_control_flags["question"]["random"]["options"] == true) {
                            shuffle_array(random_shuffle);
                            form = random_shuffle.join(" ");
                        }
                        if (typeof snip !== "undefined" && snip != false) {
                            snip = snip.replace(/\%form/g, form);
                        }

                        g_control_flags["question"]["form"] = snip;
                        // handle json
                        g_control_flags["json"] = g_control_flags["json"].replace(/\%type/g, "mcq");
                        g_control_flags["json"] = g_control_flags["json"].replace("%options", jsonsnip
                            .replace(/(^[,\s]+)|([,\s]+$)/g, ''));
                    }
                    // TODO: Lang override, replace with actual language control
                    g_control_flags["json"] = g_control_flags["json"].replace(/\%lang/g, g_state["ui"]["lang"]);

                    return snip;
                }

                //
                // Main proc loop
                //

                var raise_src_to_evalhalla = function (src) {
                    var src_a = src.split("\n");
                    var i = 0;
                    var evalhalla = [];
                    var cmd = "";

                    for (i = 0; i < src_a.length; i++) {
                        cmd = detect_command(src_a[i]);
                        if (cmd != "null") {
                            if (
                                cmd["type"] == "survey"
                                || cmd["type"] == "intro"
                                || cmd["type"] == "title"
                            ) {
                                var pack = src_a[i];
                                if (cmd["type"] == "intro") {
                                    var pkg = pack_text(src_a, i, pack);
                                    pack = pkg["pack"];
                                    i = pkg["i"];
                                }
                                evalhalla = [handle_cmd_header(cmd["type"], pack)];
                            } else if (cmd["type"] == "question"
                                || cmd["type"] == "scale"
                                || cmd["type"] == "open"
                                || cmd["type"] == "pick one"
                                || cmd["type"] == "pick any"
                                || cmd["type"] == "rank"
                            ) {
                                var pack = src_a[i];
                                var pkg = (
                                    cmd["type"] == "pick one"
                                    || cmd["type"] == "pick any"
                                    || cmd["type"] == "rank"
                                ) ? pack_text(src_a, i, pack, "[OPT] ") : pack_text(src_a, i, pack);
                                pack = pkg["pack"];
                                i = pkg["i"];

                                if (cmd["type"] == "scale"
                                    || cmd["type"] == "open"
                                    || cmd["type"] == "pick one"
                                    || cmd["type"] == "pick any"
                                    || cmd["type"] == "rank") {
                                    evalhalla.pop();
                                }
                                evalhalla.push(handle_cmd_question(cmd["type"], pack));
                            } else if (cmd["type"] == "instruction") {
                                var pack = src_a[i];
                                var pkg = pack_text(src_a, i, pack);
                                pack = pkg["pack"];
                                i = pkg["i"];
                                evalhalla.push(handle_cmd_instruction(cmd["type"], pack));
                            } else if (cmd["type"] == "random order" || cmd["type"] == "end random order") {
                                // handle randomize order
                                if (cmd["type"] == "random order") {
                                    g_control_flags["question"]["random"]["order"] = true;
                                } else if (cmd["type"] == "end random order") {
                                    g_control_flags["question"]["random"]["order"] = false;
                                }
                            } else if (cmd["type"] == "random options" || cmd["type"] == "end random options") {
                                // handle random options
                                if (cmd["type"] == "random options") {
                                    g_control_flags["question"]["random"]["options"] = true;
                                } else if (cmd["type"] == "end random options") {
                                    g_control_flags["question"]["random"]["options"] = false;
                                }
                            } else if (cmd["type"] == "end") {
                                // handle generic end, custom for random
                            } else if (cmd["type"] == "end pick" || cmd["type"] == "end rank") {
                                // skip end tag for now
                            } else {
                                // generic handler, use basic tag wrapping from g_cmd
                                evalhalla.push(cmd["html"].replace(/\%v/g, src_a[i]));
                            }
                        }
                    }
                    // random order handling
                    var return_evalhalla = "";
                    try {
                        var new_evalhalla = [];
                        var new_evalhalla_rand = [];
                        var q_index = JSON.parse(g_control_flags["json"]
                            .replace(/\,\%questions/g, "")
                            .replace(/\%options/g, "")
                            .replace(/\%questions/g, "")
                        );
                        var qs = q_index["questions"];
                        new_evalhalla.push(evalhalla[0]);

                        if (typeof qs !== "undefined") {
                            for (var k = 0; k < qs.length; k++) {
                                if (qs[k].randomOrder == "false") {
                                    if (new_evalhalla_rand.length != 0) {
                                        shuffle_array(new_evalhalla_rand);
                                        new_evalhalla.push(new_evalhalla_rand.join(""));
                                        new_evalhalla_rand = [];
                                    }
                                    new_evalhalla.push(evalhalla[k + 1]);
                                } else {
                                    new_evalhalla_rand.push(evalhalla[k + 1]);
                                }
                            }
                        }
                        shuffle_array(new_evalhalla_rand);
                        new_evalhalla.push(new_evalhalla_rand.join());
                        new_evalhalla_rand = [];
                        return_evalhalla = new_evalhalla.join("");
                    } catch (e) {
                        return_evalhalla = evalhalla.join("");
                        //M.toast({ html: 'JSON ' + e.toString(), classes: 'rounded' });
                    }


                    // save current survey signature
                    ls_update_working_survey(g_control_flags["json"]
                        .replace(/\,\%questions/g, "")
                        .replace(/\%options/g, "")
                        .replace(/\%questions/g, ""));

                    return return_evalhalla
                        .replace(/\,\%questions/g, "")
                        .replace(/\%options/g, "")
                        .replace(/\%questions/g, "")
                };

                // 
                // Material UI General
                //

                $(".sidenav").sidenav();
                $(".parallax").parallax();
                $('.fixed-action-btn').floatingActionButton();
                $('.modal').modal();
                $(".dropdown-trigger").dropdown();

                //
                // Non-Material UI general
                //

                // lang
                var refresh_lang = function () {
                    if (g_state["ui"]["lang"] == "en") {
                        $("span.en").show();
                        $("span.fr").hide();
                    } else if (g_state["ui"]["lang"] == "fr") {
                        $("span.en").hide();
                        $("span.fr").show();
                    }
                    ui_resize_textareas();
                };
                g_state["el"]["lang"].on("change", function () {
                    if (g_state["ui"]["lang"] == "en") {
                        g_state["el"]["en"].hide();
                        g_state["el"]["fr"].show();
                        g_state["ui"]["lang"] = "fr";
                        g_state["el"]["c_editor"].val(
                            g_intro_script_fr
                        );
                        // render
                        g_state["el"]["c_editor"].trigger("change");
                        // resize
                        ui_resize_textareas();
                    } else if (g_state["ui"]["lang"] == "fr") {
                        g_state["el"]["en"].show();
                        g_state["el"]["fr"].hide();
                        g_state["ui"]["lang"] = "en";
                        g_state["el"]["c_editor"].val(
                            g_intro_script
                        );
                        // render
                        g_state["el"]["c_editor"].trigger("change");
                        // resize
                        ui_resize_textareas();
                    }
                });
                //g_state["el"]["lang"].trigger("change");

                // load intro content
                g_state["el"]["c_editor"].val(
                    g_intro_script
                );

                g_state["el"]["c_editor"].on("change keyup paste", function () {
                    // get source
                    var src = g_state["el"]["c_editor"].val().replace(/\t/g, "");
                    // prep
                    reset_control_flags();
                    // E V A L H A L L A
                    var survey_html = raise_src_to_evalhalla(src);
                    // load render
                    g_state["el"]["c_render"].html(form_wrap(survey_html));
                    // reinit submit, lang refresh
                    $("#evalhalla_submit").on("click", evalhalla_submit);
                    refresh_lang();
                    // load json
                    try {
                        g_state["el"]["c_json"].val(JSON.stringify(JSON.parse(
                            g_control_flags["json"]
                                .replace(/\,\%questions/g, "")
                                .replace(/\%options/g, "")
                                .replace(/\%questions/g, "")
                        ), null, 4));
                    } catch (e) {
                        M.toast({ html: 'Hint: Use single quotes, JSON ' + e.toString(), classes: 'rounded' });
                    }
                    $('select').formSelect();
                });
                // render
                g_state["el"]["c_editor"].trigger("change");
                // resize
                ui_resize_textareas();

                // upload to survista: stub
                // TODO: Fix with correct code (right now just obj/deobj for test)
                g_state["el"]["btn_upload"].on("click", function () {
                    alert(
                        JSON.stringify(JSON.parse(
                            g_control_flags["json"]
                                .replace(/\,\%questions/g, "")
                                .replace(/\%questions/g, "")
                                .replace(/\%options/g, "")
                        ), null, 4)
                    );
                });

                // Local storage
                g_state["el"]["adm_clear_ls"].on("click", function () {
                    alert("Clearing LocalStorage...");
                    ls_clear_saved_entries();
                    g_state["el"]["c_ls"].val("");
                });

                g_state["el"]["adm_save_working_survey"].on("click", function () {
                    alert("Saving Working Survey...");
                    ls_save_survey_signature(g_control_flags["json"]
                        .replace(/\,\%questions/g, "")
                        .replace(/\%questions/g, "")
                        .replace(/\%options/g, ""), g_state["el"]["c_editor"].val());
                });

                //
                // UI Hide Show
                //

                ui_reset_panels = function () {
                    g_state["el"]["ui_render"].addClass("m4").removeClass("m12");
                    g_state["el"]["ui_render"].show();
                    g_state["el"]["ui_editor"].addClass("m4").removeClass("m12");
                    g_state["el"]["ui_editor"].show();
                    g_state["el"]["ui_json"].addClass("m4").removeClass("m12");
                    g_state["el"]["ui_json"].show();
                    // g_state["el"]["ui_ls"].addClass("m4").removeClass("m12");
                    g_state["el"]["ui_ls"].show();
                    g_state["ui"]["hs_render_window"] = false;
                    g_state["ui"]["hs_editor_window"] = false;
                    g_state["ui"]["hs_json_window"] = false;
                    g_state["ui"]["hs_ls_window"] = false;
                };
                g_state["el"]["btn_hs_ls"].on("click", function () {
                    if (g_state["ui"]["hs_ls_window"] == true) {
                        ui_reset_panels();
                    } else {
                        //g_state["el"]["ui_ls"].removeClass("m4").addClass("m12");
                        g_state["el"]["ui_ls"].show();
                        g_state["el"]["ui_render"].hide();
                        g_state["el"]["ui_editor"].hide();
                        g_state["el"]["ui_json"].hide();
                        g_state["ui"]["hs_ls_window"] = true;
                    }
                });
                g_state["el"]["btn_hs_render"].on("click", function () {
                    if (g_state["ui"]["hs_render_window"] == true) {
                        ui_reset_panels();
                    } else {
                        g_state["el"]["ui_render"].removeClass("m4").addClass("m12");
                        g_state["el"]["ui_render"].show();
                        g_state["el"]["ui_editor"].hide();
                        g_state["el"]["ui_json"].hide();
                        g_state["el"]["ui_ls"].hide();
                        g_state["ui"]["hs_render_window"] = true;
                    }
                });
                g_state["el"]["btn_hs_editor"].on("click", function () {
                    if (g_state["ui"]["hs_editor_window"] == true) {
                        ui_reset_panels();
                    } else {
                        g_state["el"]["ui_editor"].removeClass("m4").addClass("m12");
                        g_state["el"]["ui_editor"].show();
                        g_state["el"]["ui_json"].hide();
                        g_state["el"]["ui_render"].hide();
                        g_state["el"]["ui_ls"].hide();
                        g_state["ui"]["hs_editor_window"] = true;
                    }
                });
                g_state["el"]["btn_hs_json"].on("click", function () {
                    if (g_state["ui"]["hs_json_window"] == true) {
                        ui_reset_panels();
                    } else {
                        g_state["el"]["c_json"].val(JSON.stringify(JSON.parse(g_control_flags["json"]
                            .replace(/\,\%questions/g, "")
                            .replace(/\%options/g, "")
                        ), null, 4));
                        g_state["el"]["ui_json"].removeClass("m4").addClass("m12");
                        g_state["el"]["ui_json"].show();
                        g_state["el"]["ui_editor"].hide();
                        g_state["el"]["ui_render"].hide();
                        g_state["el"]["ui_ls"].hide();
                        g_state["ui"]["hs_json_window"] = true;
                    }
                });
                g_state["el"]["btn_audit"].on("click", function () {
                    alert("Auditing Evalhalla to Survista Render. Note there may be differences until both systems are fully aligned.");
                    audit_json();
                });

                //
                // Editor buttons
                //
                var get_editor_tmpl = function (cmd) {
                    if (cmd == "header") {
                        return "# 1234\n## Survey Title\n### Survey introduction text\n\n";
                    } else if (cmd == "instr") {
                        return "// Explanatory text note\n\n";
                    } else if (cmd == "qany") {
                        return "Q: This is my question?\n/any\nOption\nOption\nOption\n;\n\n";
                    } else if (cmd == "qfree") {
                        return "Q: This is my question?\n/open\n\n";
                    } else if (cmd == "qone") {
                        return "Q: This is my question?\n/one\nOption\nOption\nOption\n;\n\n";
                    } else if (cmd == "qrank") {
                        return "Q: This is my question?\n/rank\nOption\nOption\nOption\n;\n\n";
                    } else if (cmd == "qscale") {
                        return "Q: This is my question?\n/scale Low, High, Unsure\n\n";
                    } else {
                        return "";
                    }
                }
                var editor_add_template = function (cmd) {
                    g_state["el"]["c_editor"].val(
                        g_state["el"]["c_editor"].val() + get_editor_tmpl(cmd)
                    );
                    g_state["el"]["c_editor"].trigger("keyup");
                }
                var trigger_action = function (curr_action) {
                    //console.log(curr_action);
                    editor_add_template(curr_action);
                };
                var enable_editor_buttons = function (actions) {
                    g_state["el"]["edt_" + "header"].on("click", function () { trigger_action("header"); });
                    g_state["el"]["edt_" + "instr"].on("click", function () { trigger_action("instr"); });
                    g_state["el"]["edt_" + "qany"].on("click", function () { trigger_action("qany"); });
                    g_state["el"]["edt_" + "qfree"].on("click", function () { trigger_action("qfree"); });
                    g_state["el"]["edt_" + "qone"].on("click", function () { trigger_action("qone"); });
                    g_state["el"]["edt_" + "qrank"].on("click", function () { trigger_action("qrank"); });
                    g_state["el"]["edt_" + "qscale"].on("click", function () { trigger_action("qscale"); });
                    //
                    g_state["el"]["edt_erase"].on("click", function () {
                        // probs should confirm here. TODO
                        g_state["el"]["c_editor"].val("");
                        g_state["el"]["c_editor"].trigger("keyup");
                    });
                };
                enable_editor_buttons();

                //
                // Tutorial runner setup
                //

                var run_type_it = function (type_this = "type_it_short") {
                    g_state["tut"]["char_at"] = 0;
                    g_state["el"]["c_editor"].val("");
                    reset_control_flags(true);
                    clearInterval(g_state["tut"]["typer"]);
                    g_state["tut"]["typer"] = null;
                    g_state["tut"]["typer"] = setInterval(function () {
                        if (g_state["tut"]["char_at"] > g_state["tut"]["" + type_this].length) {
                            clearInterval(g_state["tut"]["typer"]);
                            g_state["tut"]["typer"] = null;
                        } else {
                            try {
                                if (typeof g_state["tut"]["" + type_this][g_state["tut"]["char_at"]] !== "undefined") {
                                    g_state["el"]["c_editor"].val(
                                        g_state["el"]["c_editor"].val() + g_state["tut"]["" + type_this][g_state["tut"]["char_at"]]
                                    );
                                    g_state["el"]["c_editor"].trigger("keyup");
                                    g_state["tut"]["char_at"] = g_state["tut"]["char_at"] + 1;
                                    ui_resize_textareas();
                                }
                            } catch (e) {
                                // do nothing
                            }
                        }
                    }, 80);
                };

                g_state["el"]["btn_tutorial"].on("click", function () {
                    if (g_state["ui"]["lang"] == "en") {
                        run_type_it("type_it_short");
                    } else {
                        run_type_it("type_it_short_fr");
                    }
                });

                // 
                // JSON Render
                //

                var audit_json = function () {
                    var src = JSON.parse(
                        g_control_flags["json"]
                            .replace(/\,\%questions/g, "")
                            .replace(/\%options/g, "")
                    );
                    var render = [];

                    //alert(JSON.stringify(src));
                    var snip = get_template_snip("header");
                    snip = snip.replace(/\%title/g, src["title"]);
                    snip = snip.replace(/\%survey/g, src["language"]);
                    snip = snip.replace(/\%intro/g, src["description"]);
                    render.push(snip);

                    var qs = src["questions"];
                    for (var k = 0; k < qs.length; k++) {
                        qsnip = "";
                        if (qs[k]["questionType"] == "instruction") {
                            qsnip = get_template_snip("instruction");
                        } else {
                            qsnip = get_template_snip("question");
                        }

                        qsnip = qsnip.replace(/\%question/g, qs[k]["question"]);
                        qsnip = qsnip.replace(/\%instruction/g, qs[k]["question"]);
                        qsnip = qsnip.replace(/\%qid/g, qs[k]["qid"]);
                        //src["language"]
                        //src["randomOrder"] // TODO
                        //src["randomOptions"] // TODO
                        var opts = qs[k]["options"];
                        var render_opts = [];
                        var opts_snip = "";
                        if (qs[k]["questionType"] == "dropdown") {
                            opts_snip = get_template_snip("scale")
                                .replace(/\%qid/g, qs[k]["qid"])
                                .replace(/\%low/g, "Low")
                                .replace(/\%high/g, "High")
                                .replace(/\%unsure/g, "Unsure")
                                ;
                        } else if (qs[k]["questionType"] == "text") {
                            opts_snip = get_template_snip("open")
                                .replace(/\%qid/g, qs[k]["qid"])
                                ;
                        }
                        if (qs[k]["questionType"] == "mcq") {
                            for (var l = 0; l < opts.length; l++) {

                                opts_snip = get_template_snip("pick one");
                                //opts_snip = get_template_snip("pick any"); // survista handles it?
                                //opts_snip = get_template_snip("rank"); // survista handles it?

                                //console.log(qs[k]["questionType"]);
                                // render_opts.push(opts[l]);                          
                                opts_snip = opts_snip
                                    .replace(/\%qid/g, qs[k]["qid"])
                                    .replace(/\%pick/g, opts[l].trim())
                                    .replace(/\%oid/g, l)
                                    ;
                                render_opts.push(opts_snip);
                                //console.log(opts_snip);
                                //random_shuffle.push(opts_snip);
                            }
                        } else {
                            render_opts.push(opts_snip);
                        }

                        qsnip = qsnip.replace(/\%form/g, render_opts.join(""));
                        //snip = snip.replace(/\%form/g, qsnip);
                        render.push(qsnip);
                    }

                    render = form_wrap(render.join(""));
                    g_state["el"]["btn_hs_render"].trigger("click");
                    g_state["el"]["c_render"].html(render);
                    // reinit submit, lang refresh
                    refresh_lang();
                    $("#evalhalla_submit").on("click", evalhalla_submit);
                    $("select").formSelect();

                };

            });
        })(jQuery);
    </script>
</body>

</html>