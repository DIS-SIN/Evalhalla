<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Evalhalla - Surveys and Evaluations done right | Enquêtes et évaluations bien faites</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" type="text/css"
        rel="stylesheet" media="screen,projection" />
    <style>
        nav ul a,
        nav .brand-logo {
            color: #444;
        }

        /* fix for massive white space on lang toggle */
        .hiddendiv-maxsized {
            overflow: hidden;
            height: auto;
            max-height: 460px;
        }

        p {
            line-height: 2rem;
        }

        .sidenav-trigger {
            color: #26a69a;
        }

        .parallax-container {
            min-height: 380px;
            line-height: 0;
            height: auto;
            color: rgba(255, 255, 255, .9);
        }

        .parallax-container .section {
            width: 100%;
        }

        @media only screen and (max-width : 992px) {
            .parallax-container .section {
                position: absolute;
                top: 40%;
            }

            #index-banner .section {
                top: 10%;
            }
        }

        @media only screen and (max-width : 600px) {
            #index-banner .section {
                top: 0;
            }
        }

        .icon-block {
            padding: 0 15px;
        }

        .icon-block .material-icons {
            font-size: inherit;
        }

        footer.page-footer {
            margin: 0;
        }

        nav ul .waves-effect i {
            display: inline;
        }

        nav ul .tab i {
            display: inline;
        }

        .pie-chart {
            padding: 0 5px 0 10px;
            width: 39px;
        }

        .pie-chart svg {
            transform: rotate(-90deg);
            vertical-align: middle;
            width: 24px;
            height: 24px;
        }

        .pie-chart path,
        .pie-chart circle {
            fill: #cccccc;
        }

        .hnpie {
            width: 20px;
            height: 20px;
        }

        /* overrides mcss */
        html {
            font-family: 'Lato', sans-serif;
            color: #333333;
        }

        blockquote {
            border-left: 0;
            margin-left: 0;
            padding-top: 10px;
            padding-bottom: 10px;
            padding-right: 5px;
            /*5px solid #26374B;*/
            background-color: rgba(238, 239, 241, 1);
            font-size: 1.4em;
            font-weight: bold;
        }

        .blue-canada-ca {
            background-color: #26374b;
        }

        .purp-canada-ca {
            background-color: #3f2a56;
        }

        .pagination li.active {
            background-color: #26374b;
        }

        .progress {
            background-color: #26374b;
            height: 18px;
            border-radius: 50px;
        }

        .progress .determinate {
            background-color: rgba(167, 181, 196, 1);
            margin: 4px;
            border-radius: 50px;
            /* fix for the 100% case where it runs outside the prog bar
            border-right: 10px solid #26374b; */
        }

        .badge {
            border-radius: 50px;
        }

        .btn,
        .btn-large {
            border-radius: 50px;
        }

        .purp-canada-ca-edged {
            border-left: 5px solid #3f2a56;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
        }

        .grey-canada-ca-block-header {
            background-color: rgba(238, 239, 241, 1);
            font-size: 1.2em;
        }

        .padbox {
            padding-left: 30px;
            padding-right: 30px;
        }

        .input-wrapper+label,
        .textarea-wrapper+label,
        .select-wrapper+label {
            font-size: 1.1em;
        }

        .dropdown-content li>a,
        .dropdown-content li>span {
            color: #333333;
        }

        textarea.materialize-textarea {
            border-bottom: 1px solid #26374b;
        }

        textarea.materialize-textarea:focus:not([readonly]) {
            border-bottom: 1px solid #26374b;
            box-shadow: 0 1px 0 0 #26374b;
        }

        .select-wrapper input.select-dropdown {
            border-bottom: 1px solid #26374b;
        }

        .select-wrapper input.select-dropdown:focus {
            border-bottom: 1px solid #26374b;
        }

        .input-field>label,
        label,
        input {
            color: #333333;
        }



        .csps-flag {
            max-height: 80px;
            float: right;
            padding: 20px;
        }

        .csps-flag-center {
            max-height: 80px;
            padding: 20px;
        }

        .bnomargin {
            margin-right: 0;
            margin-left: 0;
        }

        .bannered {
            background-image: url('static/images/top_banner.webp');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: right;
            height: 250px;
            max-height: 250px;
            /*min-height: 100px;*/
            width: 100%;
        }

        .bannerbgbacked {
            background-image: url('static/images/lp_bg.webp');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: right;
            min-height: 550px;
            height: auto;
            /*min-height: 100px;*/
            width: 100%;
        }

        fieldset {
            border: 0;
            padding: 0;
            margin: 0;
        }

        .lg-lbl {
            font-size: 1.1em;
        }

        select {
            padding: 3px;
            border-color: #333333;
        }

        select:focus {
            border: 2px solid #3f2a56;
            outline: none;
        }
    </style>
</head>

<body>
    <div class="navbar-fixed">
        <nav class="white nav-extended" role="navigation">
            <div class="nav-wrapper container">
                <a id="logo-container" href="#" class="brand-logo">Evalhalla</a>
                <a href="#" data-target="mobile-demo" class="adm-function sidenav-trigger">
                    <i class="material-icons">menu</i></a>
                <ul class="right">
                    <li>
                        <div>
                            <a class="lang" href="#">
                                <span class="en">Français</span>
                                <span class="fr">English</span>
                            </a>
                        </div>
                        <!--
                        <div class="switch">
                            <label>
                                EN
                                <input class="lang" type="checkbox">
                                <span class="lever"></span>
                                FR
                            </label>
                        </div>
                        -->
                    </li>
                </ul>
                <ul id="nav-mobile" class="adm-function right hide-on-med-and-down">
                    <li class="hide-on-small-only">
                        <a class="dropdown-trigger" href="#!" data-target="dropdown3">
                            <span class="en">
                                Insert
                            </span>
                            <span class="fr">
                                Insérer
                            </span> <i class="material-icons right">arrow_drop_down</i>
                        </a>
                    </li>
                    <li class="hide-on-small-only">
                        <a class="dropdown-trigger" href="#!" data-target="dropdown2">
                            <span class="en">View</span><span class="fr">Vue</span> <i
                                class="material-icons right">arrow_drop_down</i>
                        </a>
                    </li>
                    <li class="hide-on-small-only">
                        <a class="dropdown-trigger" href="#!" data-target="dropdown1">
                            Menu <i class="material-icons right">arrow_drop_down</i>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <ul id="dropdown1" class="adm-function dropdown-content hide-on-small-only">
        <li>
            <a href="?sur=example_nanos_paged" class="demo_ev_loop">
                <i class="material-icons">lightbulb</i>
                <span class="en">
                    Demo
                </span>
                <span class="fr">
                    Demo
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="show_me_how">
                <i class="material-icons">help</i>
                <span class="en">
                    Tutorial
                </span>
                <span class="fr">
                    Explication
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="adm_save_working_survey">
                <i class="material-icons">save</i>
                <span class="en">
                    Save
                </span>
                <span class="fr">
                    Enregistrer
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="survista_send">
                <i class="material-icons">cloud_upload</i>Survista
            </a>
        </li>
        <li><a href="#" class="audit_json_render">
                <i class="material-icons">gavel</i>
                <span class="en">Audit</span><span class="fr">Vérification</span>
            </a>
        </li>
        <li><a href="#!" class="ev-add-erase">
                <i class="material-icons">clear</i>
                <span class="en">Clear</span>
                <span class="fr">Effacer</span>
            </a></li>
        <li>
            <a href="#" class="adm_clear_ls">
                <i class="material-icons">flip_to_back</i>
                <span class="en">Reset</span><span class="fr">Réinitialiser</span>
            </a>
        </li>
    </ul>
    <ul id="dropdown2" class="adm-function dropdown-content hide-on-small-only">
        <li>
            <a href="https://app.klipfolio.com/published/692bec18aa4e866b9d7fbb5b5c355de3/satisfaction-survey">
                <i class="material-icons">cloud_upload</i>
                <span class="en">
                    Dashboard
                </span>
                <span class="fr">
                    Tableau de bord
                </span>
            </a>
        </li>
        <li>
            <a class="hs_render_window">
                <i class="material-icons">assignment</i>
                <span class="en">
                    Survey
                </span>
                <span class="fr">
                    Enquête
                </span>
            </a>
        </li>
        <li>
            <a class="hs_json_window">
                <i class="material-icons">code</i>
                <span class="en">
                    JSON
                </span>
                <span class="fr">
                    JSON
                </span>
            </a>
        </li>
        <li>
            <a class="hs_editor_window">
                <i class="material-icons">create</i>
                <span class="en">
                    Editor
                </span>
                <span class="fr">
                    Editeur
                </span>
            </a>
        </li>
        <li><a class="hs_ls_window">
                <i class="material-icons">how_to_vote</i>
                <span class="en">Storage</span><span class="fr">Storage</span>
            </a>
        </li>
        <li>
            <a href="#!" class="hs_qlib_window">
                <i class="material-icons">build</i>
                <span class="en">
                    Library
                </span>
                <span class="fr">
                    Bibliothèque
                </span>
            </a>
        </li>
    </ul>
    <ul id="dropdown3" class="adm-function dropdown-content hide-on-small-only">
        <li><a href="#!" class="ev-add-header">
                <i class="material-icons">title</i>
                <span class="en">Header</span>
                <span class="fr">En-tête</span>
            </a></li>
        <li><a href="#!" class="ev-add-instr">
                <i class="material-icons">help</i>
                <span class="en">Instruction</span>
                <span class="fr">Instruction</span>
            </a></li>
        <li><a href="#!" class="ev-add-qfree">
                <i class="material-icons">input</i>
                <span class="en">Open</span>
                <span class="fr">Libre</span>
            </a></li>
        <li><a href="#!" class="ev-add-qone">
                <i class="material-icons">done</i>
                <span class="en">One</span>
                <span class="fr">Une</span>
            </a></li>
        <li><a href="#!" class="ev-add-qany">
                <i class="material-icons">done_all</i>
                <span class="en">Any</span>
                <span class="fr">Choisir</span>
            </a></li>
        <li><a href="#!" class="ev-add-qscale">
                <i class="material-icons">call_made</i>
                <span class="en">Scale</span>
                <span class="fr">Echelle</span>
            </a></li>
        <li><a href="#!" class="ev-add-qrank">
                <i class="material-icons">import_export</i>
                <span class="en">Rate</span>
                <span class="fr">Taux</span>
            </a></li>
    </ul>
    <ul class="adm-function sidenav" id="mobile-demo">
        <li>
            <h6 class="center-align">MENU</h6>
            <hr>
        </li>
        <li>
            <a href="?sur=example_nanos_paged" class="demo_ev_loop">
                <i class="material-icons">lightbulb</i>
                <span class="en">
                    Demo
                </span>
                <span class="fr">
                    Demo
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="show_me_how">
                <i class="material-icons">help</i>
                <span class="en">
                    Tutorial
                </span>
                <span class="fr">
                    Explication
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="adm_save_working_survey">
                <i class="material-icons">save</i>
                <span class="en">
                    Save
                </span>
                <span class="fr">
                    Enregistrer
                </span>
            </a>
        </li>
        <li>
            <a href="#" class="survista_send">
                <i class="material-icons">cloud_upload</i> Survista
            </a>
        </li>
        <li>
            <a href="#" class="audit_json_render">
                <i class="material-icons">gavel</i>
                <span class="en">Audit</span><span class="fr">Vérification</span>
            </a>
        </li>
        <li><a href="#!" class="ev-add-erase">
                <i class="material-icons">clear</i>
                <span class="en">Clear</span>
                <span class="fr">Effacer</span>
            </a></li>
        <li>
            <a href="#" class="adm_clear_ls">
                <i class="material-icons">flip_to_back</i>
                <span class="en">Reset</span><span class="fr">Réinitialiser</span>
            </a>
        </li>
        <li>
            <h6 class="center-align"><span class="en">VIEW</span><span class="fr">VUE</span></h6>
            <hr>
        </li>
        <li>
            <a class="hs_render_window">
                <i class="material-icons">assignment</i>
                <span class="en">
                    Survey
                </span>
                <span class="fr">
                    Enquête
                </span>
            </a>
        </li>
        <li>
            <a class="hs_json_window">
                <i class="material-icons">code</i>
                <span class="en">
                    JSON
                </span>
                <span class="fr">
                    JSON
                </span>
            </a>
        </li>
        <li>
            <a class="hs_editor_window">
                <i class="material-icons">create</i>
                <span class="en">
                    Editor
                </span>
                <span class="fr">
                    Editeur
                </span>
            </a>
        </li>
        <li><a class="hs_ls_window">
                <i class="material-icons">how_to_vote</i>
                <span class="en">Storage</span><span class="fr">Storage</span>
            </a>
        </li>
        <li>
            <a href="#!" class="hs_qlib_window">
                <i class="material-icons">build</i>
                <span class="en">
                    Library
                </span>
                <span class="fr">
                    Bibliothèque
                </span>
            </a>
        </li>
        <li>
            <h6 class="center-align"><span class="en">INSERT</span><span class="fr">INSÉRER</span></h6>
            <hr>
        </li>
        <li><a href="#!" class="ev-add-header">
                <i class="material-icons">title</i>
                <span class="en">Header</span>
                <span class="fr">En-tête</span>
            </a></li>
        <li><a href="#!" class="ev-add-instr">
                <i class="material-icons">help</i>
                <span class="en">Instruction</span>
                <span class="fr">Instruction</span>
            </a></li>
        <li><a href="#!" class="ev-add-qfree">
                <i class="material-icons">input</i>
                <span class="en">Open</span>
                <span class="fr">Libre</span>
            </a></li>
        <li><a href="#!" class="ev-add-qone">
                <i class="material-icons">done</i>
                <span class="en">One</span>
                <span class="fr">Une</span>
            </a></li>
        <li><a href="#!" class="ev-add-qany">
                <i class="material-icons">done_all</i>
                <span class="en">Any</span>
                <span class="fr">Choisir</span>
            </a></li>
        <li><a href="#!" class="ev-add-qscale">
                <i class="material-icons">call_made</i>
                <span class="en">Scale</span>
                <span class="fr">Echelle</span>
            </a></li>
        <li><a href="#!" class="ev-add-qrank">
                <i class="material-icons">import_export</i>
                <span class="en">Rate</span>
                <span class="fr">Taux</span>
            </a></li>
    </ul>

    <div id="editor" name="editor" class="container">
        <div class="section">
            <div id="step_lang" class="row bannerbgbacked center">
                <div class="col hide-on-small-only m3"></div>
                <div class="col s12 m6 center">
                    <div>
                        <img src="static/images/csps_flag.webp" class="csps-flag-center"
                            alt="CSPS-EFPC Flag, Maple leaf in book" />
                    </div>
                    <div class="card-panel">
                        <div class="row center">
                            <h4><span class="en">Satisfaction Survey</span><span class="fr">Enquête de
                                    satisfaction</span></h4>
                            <p>
                                Language of preference - Langue de préférence
                            </p>
                        </div>

                        <div class="row center">
                            <div class="col s12 m6 center">
                                <div class="row center">
                                    <button class="lang-set-en purp-canada-ca btn-large">English</button>
                                </div>
                            </div>
                            <div class="col s12 m6 center">
                                <div class="row center">
                                    <button class="lang-set-fr purp-canada-ca btn-large">Français</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="col hide-on-small-only m3"></div>
            </div>
            <div id="step_offering" class="row bannerbgbacked center">
                <div class="col hide-on-small-only m2"></div>
                <div class="col s12 m8 center">
                    <div>
                        <img src="static/images/csps_flag.webp" class="csps-flag-center"
                            alt="CSPS-EFPC Flag, Maple leaf in book" />
                    </div>
                    <div class="card-panel">
                        <div class="row center">
                            <h4><span class="en">Satisfaction Survey</span><span class="fr">Enquête de
                                    satisfaction</span></h4>
                            <p>
                                <span class="en">Please choose your course offering</span>
                                <span class="fr">Veuillez choisir votre offre de cours</span>
                            </p>
                        </div>

                        <div class="row center offering_target">
                            OFFERINGS
                        </div>

                    </div>
                </div>
                <div class="col hide-on-small-only m2"></div>
            </div>
            <div id="step_tombstone" class="row bannerbgbacked center">
                <div class="col hide-on-small-only m1"></div>
                <div class="col s12 m10 center">
                    <div>
                        <img src="static/images/csps_flag.webp" class="csps-flag-center"
                            alt="CSPS-EFPC Flag, Maple leaf in book" />
                    </div>
                    <div class="card-panel">
                        <div class="row center">
                            <h4><span class="en">Satisfaction Survey</span><span class="fr">Enquête de
                                    satisfaction</span></h4>
                            <p>
                                <span class="en">A bit about you</span>
                                <span class="fr">Un peu de vous</span>
                            </p>
                        </div>

                        <div class="row center tombstone_target">

                            <div class="row">
                                <div class="col s12">
                                    <div class="input-field col s12">
                                        <input type="text" id="autocomplete-input-department"
                                            class="autocomplete tombstone_department">
                                        <label for="autocomplete-input-department"><span
                                                class="en">Department</span><span class="fr">Département</span></label>
                                    </div>
                                </div>
                                <div class="col s12">
                                    <div class="input-field col s12">
                                        <input type="text" id="autocomplete-input-classification"
                                            class="autocomplete tombstone_classification">
                                        <label for="autocomplete-input-classification">Classification</label>
                                    </div>
                                </div>

                                <div class="col s12">
                                    <div class="input-field col s12">
                                        <input type="text" id="autocomplete-input-city"
                                            class="autocomplete tombstone_city">
                                        <label for="autocomplete-input-city"><span class="en">City</span><span
                                                class="fr">Ville</span></label>
                                    </div>
                                </div>
                                <div class="col s12">
                                    <div class="row center">
                                        <button class="tombstone-set purp-canada-ca btn-large"><span
                                                class="en">Start</span><span class="fr">Début</span></button>
                                    </div>
                                </div>
                                <!--
                                <div class="col s6">
                                    <div class="input-field s6">
                                        <input id="inline_qid_%qid_office_3" class="ev_inline_office %reqcls" %reqattr
                                            name="inline_qid_%qid_office_3" type="text">
                                        <label for="inline_qid_%qid_office_3"><span class="en">Office</span><span class="fr">Office</span></label>
                                    </div>
                                </div>-->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col hide-on-small-only m1"></div>
            </div>
            <div id="step_thank_you_cta" class="row bannerbgbacked center">
                <div class="col hide-on-small-only m2"></div>
                <div class="col s12 m8 center">
                    <div>
                        <img src="static/images/csps_flag.webp" class="csps-flag-center"
                            alt="CSPS-EFPC Flag, Maple leaf in book" />
                    </div>



                    <div class="card-panel">
                        <div class="row center">
                            <i class="material-icons" style="color: #7cb342;font-size:5em;">check_circle</i>
                            <h4><span class="en">You're Awesome!</span><span class="fr">Vous êtes génial!</span></h4>
                            <p>
                                <span class="en">Thank you for taking the time</span>
                                <span class="fr">Merci d'avoir pris le temps de répondre</span>
                            </p>

                            <div class="row center">
                                <button class="ev-ready-for-next purp-canada-ca btn-large"><span
                                        class="en">Goodbye</span><span class="fr">Au revoir</span></button>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="col hide-on-small-only m2"></div>
            </div>
        </div>
        <div class="section">
            <div class="row">
                <div id="editor_window" class="col s12 m6">
                    <form class="col s12">
                        <div class="row">
                            <div class="input-field col s12">
                                <textarea id="editor_target" class="materialize-textarea"
                                    data-original-height=0></textarea>
                                <label for="editor_target">
                                    <span class="en">
                                        Survey Source (TYPE HERE).
                                    </span>
                                    <span class="fr">
                                        Source d'enquête (TYPE ICI).
                                    </span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div id="render_window" class="col s12 m6">
                    <div class="row">
                        <div id="render_target"></div>
                    </div>
                </div>
                <div id="ls_window" class="col s12 m12">
                    <div class="row">
                        <form class="col s12">
                            <div class="input-field col s12">
                                <h5>
                                    <span class="en">
                                        Local Storage (in browser)
                                    </span>
                                    <span class="fr">
                                        Storage Locale (en browser)
                                    </span>
                                </h5>

                                <a href="#" class="update_ls btn blue-canada-ca">
                                    <i class="material-icons">refresh</i>
                                    Update
                                </a>

                                <div id="ls_target"></div>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="json_window" class="col s12 m12">
                    <div class="row">
                        <form class="col s12">
                            <div class="input-field col s12">
                                <textarea id="json_target" class="materialize-textarea"
                                    data-original-height=0></textarea>
                                <label for="json_target">
                                    <span class="en">
                                        Survey JSON (auto-generated).
                                    </span>
                                    <span class="fr">
                                        Survey JSON (généré automatiquement).
                                    </span>
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="qlib_window" name="qlib_window" class="col s12 m12">
                    <div class="row">
                        <nav>
                            <div class="nav-wrapper light-blue darken-1">
                                <div class="col s12">
                                    <span class="en">Library</span><span class="fr">Bibliothèque</span>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="row">
                        <table class="highlight responsive-table">
                            <thead>
                                <tr>
                                    <th><span class="en">Details</span><span class="fr">Details</span></th>
                                    <th><span class="en">Add</span><span class="fr">Adjouter</span></th>
                                </tr>
                            </thead>
                            <tbody id="qlib_target"> </tbody>
                        </table>
                    </div>
                    <div class="row">
                        <label for="qlib"><span class="en">Question Library</span><span class="fr">Bibliothèque de
                                Questions</span></label>
                        <textarea id="qlib" class="materialize-textarea"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer id="admin_footer_end" class="page-footer purp-canada-ca">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">Evalhalla</h5>
                    <p class="grey-text text-lighten-4">
                        <span class="en">Alpha. Evalhalla is an experiment in making form creation easier.</span>
                        <span class="fr">Alpha. Evalhalla est une expérience visant à faciliter la création de
                            formulaires.</span>
                    </p>
                    <a class="brown-text text-lighten-3" href="https://github.com/DIS-SIN/">DIS-SIN Github</a>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                <span class="en">Forms that function.</span>
                <span class="fr">Des formes qui fonctionnent.</span>
            </div>
        </div>
    </footer>
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large blue-canada-ca" href="#editor">
            <i class="large material-icons">arrow_upward</i>
        </a>
    </div>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/1.0.10/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- DEMO Statics for Tombstone autocomplete -->
    <script src="example_sur.js"></script>
    <script src="static/assets/departments.js"></script>
    <script src="static/assets/classifications.js"></script>
    <script src="static/assets/cities.js"></script>
    <!-- DEMO API Connection -->
    <script src="integrations/registhor/registhor_key.js"></script>
    <script src="integrations/survista/survista_key.js"></script>
    <script src="static/assets/evalese_md_scripts.js"></script>
    <script>
        (function ($) {
            $(function () {
                //
                // EVALHALLA
                //
                // Just type. It will make your form HTML and JSON
                // Think more code less.
                //

                //
                // HTML, JSON, and EVALESE snips
                //

                const config_DOMPurify = {
                    /*ALLOWED_TAGS: ['p', '#text']*/
                    SAFE_FOR_JQUERY: true,
                    KEEP_CONTENT: false
                };
                // Clean HTML string and write into our DIV
                const safe = function (dirty) {
                    return DOMPurify.sanitize(dirty, config_DOMPurify);
                };

                // These are the "EVALESE" command. This is the markdown that builds the forms.
                // You can easily add new aliases for the core commands. Just make sure you check
                // yourself. There's not much in the way of error catching here. It trusts you.
                const g_cmd = {
                    // CMDS in ALLCAPS, but input is any case
                    "[SURVEY]": { "type": "survey", "html": "<survey>%v</survey>" },
                    "#": { "type": "survey", "html": "<survey>%v</survey>" },
                    "[TITLE]": { "type": "title", "html": "<title>%v</title>" },
                    "##": { "type": "title", "html": "<title>%v</title>" },
                    "[INTRO]": { "type": "intro", "html": "<intro>%v</intro>" },
                    "###": { "type": "intro", "html": "<intro>%v</intro>" },
                    "[QUESTION]": { "type": "question", "html": "<question>%v</question>" },
                    "Q:": { "type": "question", "html": "<question>%v</question>" },
                    "[*QUESTION]": { "type": "req question", "html": "<question>%v</question>" },
                    "*Q:": { "type": "req question", "html": "<question>%v</question>" },
                    "[SCALE]": { "type": "scale", "html": "<scale>%v</scale>" },
                    "/SCALE": { "type": "scale", "html": "<scale>%v</scale>" },
                    "/ÉCHELLE": { "type": "scale", "html": "<scale>%v</scale>" },
                    "|": { "type": "scale", "html": "<scale>%v</scale>" },
                    "[OPEN]": { "type": "open", "html": "<open>%v</open>" },
                    "/OPEN": { "type": "open", "html": "<open>%v</open>" },
                    "/OUVRIR": { "type": "open", "html": "<open>%v</open>" },
                    "@": { "type": "open", "html": "<open>%v</open>" },
                    "[INSTRUCTION]": { "type": "instruction", "html": "<instruction>%v</instruction>" },
                    "//": { "type": "instruction", "html": "<instruction>%v</instruction>" },
                    "[END]": { "type": "end", "html": "<end>%v</end>" },
                    ";": { "type": "end", "html": "<end>%v</end>" },
                    "[RANDOMORDER]": { "type": "random order", "html": "<rand>%v</rand>" },
                    "~": { "type": "random order", "html": "<rand>%v</rand>" },
                    "/RAND": { "type": "random order", "html": "<rand>%v</rand>" },
                    "[RANDOMIZEORDER]": { "type": "random order", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMORDER]": { "type": "end random order", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMIZEORDER]": { "type": "end random order", "html": "<rand>%v</rand>" },
                    ";~": { "type": "end random order", "html": "<rand>%v</rand>" },
                    ";RAND": { "type": "end random order", "html": "<rand>%v</rand>" },
                    "[RANDOMOPTIONS]": { "type": "random options", "html": "<rand>%v</rand>" },
                    "~~": { "type": "random options", "html": "<rand>%v</rand>" },
                    "/RANDO": { "type": "random options", "html": "<rand>%v</rand>" },
                    "[RANDOMIZEOPTIONS]": { "type": "random options", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMOPTIONS]": { "type": "end random options", "html": "<rand>%v</rand>" },
                    "[ENDRANDOMIZEOPTIONS]": { "type": "end random options", "html": "<rand>%v</rand>" },
                    ";~~": { "type": "end random options", "html": "<rand>%v</rand>" },
                    ";RANDO": { "type": "end random options", "html": "<rand>%v</rand>" },
                    "[PICKONE]": { "type": "pick one", "html": "<pick>%v</pick>" },
                    "/ONE": { "type": "pick one", "html": "<pick>%v</pick>" },
                    "/UN": { "type": "pick one", "html": "<pick>%v</pick>" },
                    ".": { "type": "pick one", "html": "<pick>%v</pick>" },
                    "[PICKANY]": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "/ANY": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "/TOUT": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "*": { "type": "pick any", "html": "<pick>%v</pick>" },
                    "[ENDPICK]": { "type": "end pick", "html": "<pick>%v</pick>" },
                    "[RANK]": { "type": "rank", "html": "<rank>%v</rank>" },
                    "/RANK": { "type": "rank", "html": "<rank>%v</rank>" },
                    "/TAUX": { "type": "rank", "html": "<rank>%v</rank>" },
                    "$": { "type": "rank", "html": "<rank>%v</rank>" },
                    "[RATE]": { "type": "rank", "html": "<rank>%v</rank>" },
                    "/RATE": { "type": "rank", "html": "<rank>%v</rank>" },
                    "[ENDRANK]": { "type": "end rank", "html": "<rank>%v</rank>" },
                    "[ENDRATE]": { "type": "end rank", "html": "<rank>%v</rank>" },
                    "/GENERICS": { "type": "generics", "html": "<generics>%v</generics>" },
                    "[GENERICS]": { "type": "generics", "html": "<generics>%v</generics>" },
                    "/PAGEBREAK": { "type": "page break", "html": "<page break>%v</page break>" },
                    "[PAGEBREAK]": { "type": "page break", "html": "<page break>%v</page break>" }

                };

                //
                // Example Overrides
                //
                var auto_display_mode = false; // if you pass a query param in with sur=example_nanos_paged for example, it goes right into "presentation mode"
                var params = null; // the search params
                var sur = null; // the survey to load
                try {
                    params = new URLSearchParams(window.location.search);
                    sur = params.get("sur");
                } catch (e) {
                    // good old Internet Explorer or Edge. Still writing "special" code for you...
                    params = window.location.search.split("=")[1]; // yep, I actually did that.
                    sur = params; // very cross. much browser. so wow.
                }
                // ok let's load it up
                if (sur == "example_nanos") { g_intro_script = example_nanos; auto_display_mode = true; }
                if (sur == "example_nanos_paged") { g_intro_script = example_nanos_paged; auto_display_mode = true; }

                // wraps the generated elements in a form and a paginator
                var form_wrap = function (src) {
                    var pages = "";
                    for (var i = 1; i <= g_control_flags["pageid"]; i++) {
                        pages += `<li class="waves-effect ev-page-sel ev-page-sel-` + i + `"><a href="#!">` + i + `</a></li>`;
                    }
                    return '' +
                        '<div class="row">' +
                        '<div class="col s12 center">' +
                        `<strong class="center-align determinate-text">` + ((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + `%</strong>` +
                        `</div><div class="progress">
                        <div class="determinate" style="width: `+ ((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + `%"></div>
                        </div></div>`+
                        `<div class="row">
                            <div class="col s12 center bannered">`+
                        //<img src="static/images/top_banner.webp" class="responsive-img" alt="CSPS-EFPC Branding, Humans in classroom" />
                        `<img src="static/images/csps_flag.webp" class="responsive-img csps-flag" alt="CSPS-EFPC Flag, Maple leaf in book" />
                            </div>
                        </div>
                        `+
                        '<form id="evalhalla_form" action="#">' +
                        '<div class="ev-page ev-page-1 card-panel">' +
                        src +
                        '</div>' +
                        ` <ul class="pagination center-align">
                            <li class="waves-effect ev-page-sel-left"><a href="#!"><i class="material-icons">chevron_left</i></a></li>`+
                        pages +
                        `<li class="waves-effect ev-page-sel-right"><a href="#!"><i class="material-icons">chevron_right</i></a></li>
                        </ul>
                        `+
                        '<div class="row">' +
                        '<div class="col s12 center">' +
                        '<a id="evalhalla_submit" class="waves-effect waves-light purp-canada-ca btn-large">' +
                        //'<i class="material-icons right">cloud</i>'+    
                        '<span class="en">SUBMIT</span><span class="fr">PROVIR</span></a>' +
                        '</div>' +
                        '</div>' +
                        '</form>' +
                        '';
                };
                // return a json or html snip with %replaceme codons/tokens sprinkled in
                // the general idea here is to use these like a templating lang. Just waaaay simpler
                // For huge surveys we might get into hot water performance wise
                // theres about 160 .replace regexes - but for our problem domain we're aiming
                // for small short and light surveys.
                var get_template_snip = function (snip, format = "html") {
                    if (snip == "header") {
                        if (format == "json") {
                            return '{' +
                                '"title": "%title",' +
                                '"description": "%intro",' +
                                '"language": "%lang",' +
                                '"questions": [%questions]' +
                                '}';
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="col s12 center">' +
                            //'<h3><i class="mdi-content-send brown-text"></i></h3>' +
                            '<h4>%title<br/>(%survey)</h4>' +
                            '<p class="flow-text left-align light">%intro</p>' +
                            '</div>' +
                            '</div>';
                    } else if (snip == "question" || snip == "req question") {
                        if (format == "json") {
                            return '{' +
                                '"qid": "%qid",' +
                                '"question": "%question",' +
                                '"description": "%question",' +
                                '"language": "%lang",' + // en or fr
                                '"questionType": "%type",' + //mcq 'text' , 'dropdown',
                                '"required": "%req",' +
                                '"randomOrder": "%rand_order",' +
                                '"randomOptions": "%rand_options",' +
                                '"options": [%options]' +
                                '}';
                        }
                        return '' +
                            '<div class="card-panel purp-canada-ca-edged">' +
                            '<blockquote><span class="badge" style="font-size:1.5em;margin:0px;">' +
                            //'<strong>#%qid</strong>'+
                            '%req</span> %question</blockquote><div class="padbox">%form</div>' +
                            '</div>' +
                            '';
                    } else if (snip == "scale") {
                        if (format == "json") {
                            return '"1 %low",' +
                                '"2",' +
                                '"3",' +
                                '"4",' +
                                '"5",' +
                                '"6",' +
                                '"7",' +
                                '"8",' +
                                '"9",' +
                                '"10 %high",' +
                                '"%unsure"';
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="col s12" >' +
                            '<label class="lg-lbl" for="scale_qid_%qid" id="lbl_scale_qid_%qid"><span class="en">Choose your rating</span><span class="fr">Chosir s.v.p.</span></label>' +
                            '<select class="%reqcls browser-default" %reqattr id="scale_qid_%qid" name="scale_qid_%qid" aria-labelledby="lbl_scale_qid_%qid">' +
                            '<option value="" disabled selected></option>' +
                            '<option value="1">1 %low</option>' +
                            '<option value="2">2</option>' +
                            '<option value="3">3</option>' +
                            '<option value="4">4</option>' +
                            '<option value="5">5</option>' +
                            '<option value="6">6</option>' +
                            '<option value="7">7</option>' +
                            '<option value="8">8</option>' +
                            '<option value="9">9</option>' +
                            '<option value="10">10 %high</option>' +
                            '<option value="77">%unsure</option>' +
                            '</select>' +
                            '</div> ' +
                            '</div> ' +
                            '';
                    } else if (snip == "open") {
                        if (format == "json") {
                            return "";
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="row">' +
                            '<div class="input-field col s12">' +
                            '<label for="textarea_qid_%qid"><span class="en">Enter your answer</span><span class="fr">Provir votre reponse</span></label>' +
                            '<textarea type="text" %reqattr id="textarea_qid_%qid" name="textarea_qid_%qid" class="%reqcls materialize-textarea"></textarea>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '';
                    } else if (snip == "pick one") {
                        if (format == "json") {
                            return '"%pick"';
                        }
                        return '' +
                            '<div class="row">' +
                            '<label>' +
                            '<input class="with-gap %reqcls" %reqattr name="rgroup_qid_%qid" type="radio" value="%vpick" />' +
                            '<span>%pick</span>' +
                            '</label>' +
                            '</div>' +
                            '';
                    } else if (snip == "pick any") {
                        if (format == "json") {
                            return '"%pick"';
                        }
                        return '' + // no validation needed, you pick any. Any includes none.
                            '<div class="row">' +
                            '<label>' +
                            '<input class="with-gap" name="cgroup_qid_%qid[]" type="checkbox" value="%vpick" />' +
                            '<span>%pick</span>' +
                            '</label>' +
                            '</div>' +
                            '';
                    } else if (snip == "rank") {
                        if (format == "json") {
                            return '"%pick"';
                        }
                        return '' +
                            '<div class="row">' +
                            '<div class="col s12">' +
                            '<div class="input-field s12">' +
                            '<input class="%reqcls" %reqattr id="inline_qid_%qid_oid_%oid" name="inline_qid_%qid_oid_%oid" type="text">' +
                            '<label for="inline_qid_%qid_oid_%oid">%pick</label>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '';
                    } else if (snip == "instruction") {
                        if (format == "json") {
                            return '{' +
                                '"qid": "none",' +
                                '"question": "%instruction",' +
                                '"description": "%instruction",' +
                                '"language": "%lang",' + // en or fr
                                '"questionType": "instruction",' + //mcq 'text' , 'dropdown',
                                '"randomOrder": "%rand_order",' +
                                '"randomOptions": "%rand_options",' +
                                '"options": []' +
                                '}';
                        }
                        return '' +
                            '<div class="card-panel blue-canada-ca darken-2">' +
                            '<span class="white-text">%instruction</span>' +
                            '</div>' +
                            '';
                    } else if (snip == "ls") {
                        return '' +
                            '<table class="highlight responsive-table">' +
                            '<thead>' +
                            '<tr>' +
                            '<th><span class="en">Survey</span><span class="fr">Enquête</span></th>' +
                            '<th><span class="en">Details</span><span class="fr">Details</span></th>' +
                            '<th><span class="en">Lang</span><span class="fr">Lang</span></th>' +
                            '<th><span class="en">Items</span><span class="fr">Articles</span></th>' +
                            '</tr>' +
                            '</thead>' +
                            '<tbody>' +
                            '%tbody' +
                            '</tbody>' +
                            '</table>' +
                            '';
                    } else if (snip == "ls_header") {
                        return '' +
                            '<nav><div class="nav-wrapper blue-canada-ca darken-1"><div class="col s12">' +
                            '<span class="en">%en</span><span class="fr">%fr</span>' +
                            '</div></div></nav>' +
                            '';
                    } else if (snip == "generics") {
                        // todo only one generics
                        // TODO JSON
                        // Generics was the prototype of tombstone. Repurpose for other "generic fields"
                        if (format == "json") {
                            return '"%field"';
                        }
                        return `
                            <div class="row">
                            <div class="col s6">
                            <div class="input-field s6">
                            <input id="inline_qid_%qid_dept_0" class="ev_inline_dept %reqcls" %reqattr name="inline_qid_%qid_dept_0" type="text">
                            <label for="inline_qid_%qid_dept_0"><span class="en">Department</span><span class="fr">Department</span></label>
                            </div>
                            </div>
                            <div class="col s6">
                            <div class="input-field s6">
                            <input id="inline_qid_%qid_role_1" class="ev_inline_role %reqcls" %reqattr  name="inline_qid_%qid_role_1" type="text">
                            <label for="inline_qid_%qid_role_1"><span class="en">Role</span><span class="fr">Role</span></label>
                            </div>
                            </div>
                            </div>
                            <div class="row">
                            <div class="col s6">
                            <div class="input-field s6">
                            <input id="inline_qid_%qid_region_2" class="ev_inline_region %reqcls" %reqattr  name="inline_qid_%qid_region_2" type="text">
                            <label for="inline_qid_%qid_region_2"><span class="en">Region</span><span class="fr">Region</span></label>
                            </div>
                            </div>
                            <div class="col s6">
                            <div class="input-field s6">
                            <input id="inline_qid_%qid_office_3" class="ev_inline_office %reqcls" %reqattr  name="inline_qid_%qid_office_3" type="text">
                            <label for="inline_qid_%qid_office_3"><span class="en">Office</span><span class="fr">Office</span></label>
                            </div>
                            </div>
                            </div>
                            `;
                    } else if (snip == "qlib entry") {
                        return `<tr>
                                    <td>
                                        <div id="bqlib_%bqid">%question
                                        </div>
                                    </td>
                                    <td>%ctrl</td>
                                </tr>`;
                    } else if (snip == "page break") {
                        if (format == "json") {
                            return '{' +
                                '"qid": "none",' +
                                '"question": "none",' +
                                '"description": "none",' +
                                '"language": "none",' + // en or fr
                                '"questionType": "page break",' + //mcq 'text' , 'dropdown',
                                '"randomOrder": "false",' +
                                '"randomOptions": "false",' +
                                '"options": []' +
                                '}';
                        }
                        return `</div><div class="ev-page ev-page-%pageid card-panel">`;
                    }

                    return "";
                };

                //
                // Question Libary
                //
                // This is a copy/paste storage for questions you have in the editor.
                // Once you start building surveys this makes it easier to make new ones
                // Why have to do stuff over and over right?
                var update_question_library = function () {
                    var qlib = safe($("#qlib").val());
                    if (qlib == "") {
                        qlib = "Q: Example?\n/open\n\nQ: Example 2?\n/open\n";
                        $("#qlib").val(qlib);
                    }
                    qlib = qlib.split("\n\n");
                    var tbody = "";
                    for (var i = 0; i < qlib.length; i++) {
                        tbody += get_template_snip("qlib entry")
                            .replace(/\%bqid/g, i)
                            .replace(/\%question/g, qlib[i])
                            .replace(/\%ctrl/g, '<a id="ql_' + i + '" class="btn-small bqlib">Add</a>')

                    }
                    $("#qlib_target").html(tbody);
                    $(".bqlib").on("click", function () {
                        var bqid = $(this).attr("id");
                        bqid = bqid.replace("ql_", "");
                        var text = $("#bqlib_" + bqid).html();
                        g_state["el"]["c_editor"].val(
                            g_state["el"]["c_editor"].val() +
                            "\n" +
                            text
                        );
                        g_state["el"]["c_editor"].trigger("keyup");
                    });
                }


                //
                // Basic Pre-Survista Charting
                //
                // The idea here is so that you can use localStorage to save the responses on
                // the device you're using (lets say you wanna decide what pizza to order for a meeting)
                // This will let you build the survey, pass the device around, and then see a chart of the 
                // results right away.

                // Random HSL Color value generation
                var randomCoord = 0;
                var lastCoord = 0;
                var currCoord = Math.random() * 360;
                var slicecount = 0;
                const randomHsl = () => {
                    slicecount = slicecount + 1;
                    if (slicecount % 2 == 0) {
                        currCoord = (currCoord + 90) % 360;
                    } else {
                        currCoord = ((lastCoord + currCoord) / 2 + 90) % 360;
                    }
                    lastCoord = currCoord;
                    currCoord = currCoord + 61; // prime between 45 and 90

                    return `hsla(${currCoord}, 70%, 70%, 1)`;
                }
                // svg basic pie chart
                var hackernoon_pie = function (elid, slices) {
                    // just read this. trust me: https://hackernoon.com/a-simple-pie-chart-in-svg-dbdd653b6936
                    var svgEls = [document.getElementById(elid)];

                    if (slices == null) {
                        //slices = [];
                        for (var i = 0; i < 100; i++) {
                            slices.push({ percent: 0.01, color: randomHsl() })
                        }
                    }
                    let cumulativePercent = 0;

                    function getCoordinatesForPercent(percent) {
                        const x = Math.cos(2 * Math.PI * percent);
                        const y = Math.sin(2 * Math.PI * percent);
                        return [x, y];
                    }
                    for (var i = 0; i < svgEls.length; i++) {
                        slices.forEach(slice => {
                            // destructuring assignment sets the two variables at once
                            const [startX, startY] = getCoordinatesForPercent(cumulativePercent);
                            // each slice starts where the last slice ended, so keep a cumulative percent
                            cumulativePercent += slice.percent;
                            const [endX, endY] = getCoordinatesForPercent(cumulativePercent);
                            // if the slice is more than 50%, take the large arc (the long way around)
                            const largeArcFlag = slice.percent > .5 ? 1 : 0;
                            // create an array and join it just for code readability
                            /* 
                            // Pie Chart Filled
                            const pathData = [
                                `M ${startX} ${startY}`, // Move
                                `A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY}`, // Arc
                                `L 0 0`, // Line
                            ].join(' ');
                            */
                            // Donut chart
                            const thickness = .3;
                            const pathData = [
                                `M ${startX} ${startY}`,
                                `A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY}`,
                                /** next two lines added for donut chart, as well as thickness constant*/
                                `L ${endX * thickness} ${endY * thickness}`,
                                `A ${thickness} ${thickness} 0 ${largeArcFlag} 0 ${startX * thickness} ${startY * thickness}`,
                            ].join(' ');

                            // create a <path> and append it to the <svg> element
                            const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            pathEl.setAttribute('d', pathData);
                            pathEl.setAttribute('fill', slice.color);
                            svgEls[i].appendChild(pathEl);
                        })
                    }
                }
                // slug all the things
                // read: https://medium.com/@mhagemann/the-ultimate-way-to-slugify-a-url-string-in-javascript-b8e4a0d849e1
                function slugify(string) {
                    const a = 'àáäâãåăæçèéëêǵḧìíïîḿńǹñòóöôœṕŕßśșțùúüûǘẃẍÿź·/_,:;'
                    const b = 'aaaaaaaaceeeeghiiiimnnnoooooprssstuuuuuwxyz------'
                    const p = new RegExp(a.split('').join('|'), 'g')
                    return string.toString().toLowerCase()
                        .replace(/\s+/g, '-') // Replace spaces with -
                        .replace(p, c => b.charAt(a.indexOf(c))) // Replace special characters
                        .replace(/&/g, '-and-') // Replace & with ‘and’
                        .replace(/[^\w\-]+/g, '') // Remove all non-word characters
                        .replace(/\-\-+/g, '-') // Replace multiple - with single -
                        .replace(/^-+/, '') // Trim - from start of text
                        .replace(/-+$/, '') // Trim - from end of text
                }
                //
                // LocalStorage for client side info store
                //

                // do we even has this?
                var ls_storageAvailable = function (type) {
                    var storage;
                    try {
                        storage = window[type];
                        var x = '__storage_test__';
                        storage.setItem(x, x);
                        storage.removeItem(x);
                        return true;
                    } catch (e) {
                        return e instanceof DOMException && (
                            // everything except Firefox
                            e.code === 22 ||
                            // Firefox
                            e.code === 1014 ||
                            // test name field too, because code might not be present
                            // everything except Firefox
                            e.name === 'QuotaExceededError' ||
                            // Firefox
                            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
                            // acknowledge QuotaExceededError only if there's something already stored
                            (storage && storage.length !== 0);
                    }
                }

                var warn_user_no_storage = false; // this will fire once and only once. No need to annoy.
                var warn_user_alert = function () {
                    // Too bad, no localStorage for us
                    if (warn_user_no_storage == false) {
                        alert("This device does not support local storage. Save feature disabled.");
                        warn_user_no_storage = true;
                    }
                }

                // TODO: Pull out template code into snips
                // TODO: Optimize render, no need to show ls on every keystroke
                // display the report of the stored information. Survey, Responses, all of it.
                var ls_show_local_storage = function () {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        var display_str = "";
                        var tbody = "";


                        display_str += get_template_snip("ls_header").replace(/\%en/g, "Working Survey").replace(/\%fr/g, "Enquête en cours").replace(/\%count/g, "");
                        display_str += get_template_snip("ls");
                        tbody = "";
                        if (ev_ls["working_survey"] != null) {
                            tbody += "<tr><td>" +
                                (ev_ls["working_survey"]["title"] != null ? ev_ls["working_survey"]["title"] : "") +
                                "</td><td>" +
                                (ev_ls["working_survey"]["description"] != null ? ev_ls["working_survey"]["description"] : "") +
                                "</td><td>" +
                                (ev_ls["working_survey"]["language"] != null ? ev_ls["working_survey"]["language"] : "") +
                                "</td><td>" +
                                (ev_ls["working_survey"]["questions"] != null ? ev_ls["working_survey"]["questions"].length : "") +
                                "</td><tr>" +
                                "";
                        } else {
                            tbody = "<tr><td>None</td><td></td><td></td><td></td>";
                        }
                        display_str = display_str.replace(/\%tbody/g, tbody);

                        display_str += get_template_snip("ls_header").replace(/\%en/g, "Saved Survey").replace(/\%fr/g, "Enquête Sauvegardées");
                        display_str += get_template_snip("ls");
                        tbody = "";
                        if (ev_ls["saved_survey_signatures"] != null
                            && ev_ls["saved_survey_signatures"].length > 0) {
                            display_str = display_str.replace(/\%count/g, ev_ls["saved_survey_signatures"].length);
                            var cs = null;
                            for (var l = 0; l < ev_ls["saved_survey_signatures"].length; l++) {
                                cs = ev_ls["saved_survey_signatures"][l]["survista"];
                                tbody += '<tr><td><a href="#" id="sv_sr_' + l + '" class="adm_load_survey">' +
                                    (cs["title"] != null ? cs["title"] : "") +
                                    "</a></td><td>" +
                                    (cs["description"] != null ? cs["description"] : "") +
                                    "</td><td>" +
                                    (cs["language"] != null ? cs["language"] : "") +
                                    "</td><td>" +
                                    (cs["questions"] != null ? cs["questions"].length : "") +
                                    "</td><tr>" +
                                    "";
                            }
                        } else {
                            tbody = "<tr><td>-</td><td></td><td></td><td></td>";
                        }
                        display_str = display_str.replace(/\%count/g, "0");
                        display_str = display_str.replace(/\%tbody/g, tbody);

                        display_str += get_template_snip("ls_header").replace(/\%en/g, "Saved Responses").replace(/\%fr/g, "Réponses Sauvegardées");
                        display_str += get_template_snip("ls");
                        tbody = "";
                        if (ev_ls["saved_filled_survey_responses"] != null && ev_ls["saved_filled_survey_responses"].length > 0) {
                            display_str = display_str.replace(/\%count/g, ev_ls["saved_filled_survey_responses"].length);
                            var survey = "", answer = "", answer_text = "", keys = "", qid = "", q = "", qida = [], opt_text = "", type = "";
                            var tabulation = {};
                            for (var l = 0; l < ev_ls["saved_filled_survey_responses"].length; l++) {
                                answer_text = [];
                                survey = ev_ls["saved_filled_survey_responses"][l]["survey"];
                                answer = ev_ls["saved_filled_survey_responses"][l]["response"];

                                // key = Object.keys(answer);
                                if (typeof survey["questions"] !== "undefined") {
                                    for (var k in answer) {
                                        type = (k.split("_"))[0];
                                        qida = (k.match(/\d+/g));
                                        qid = "";
                                        try {
                                            qid = qida[0];
                                        } catch (e) {
                                            qid = -1;
                                        }
                                        oid = "";

                                        //console.log(qid, k);

                                        if (typeof tabulation[survey["title"]] === "undefined") {
                                            tabulation[survey["title"]] = {};
                                        }


                                        q = survey["questions"].find(function (element) {
                                            return element["qid"] == qid;
                                        });
                                        opt_text = "";
                                        try {
                                            if (typeof qida[1] !== "undefined") {
                                                oid = qida[1];
                                                opt_text = q["options"][oid];
                                            }
                                        } catch (e) {
                                            // do nothing
                                        }
                                        var ans_key = ("Q" + qid + " " + opt_text).trim();
                                        if (typeof q !== "undefined") {
                                            if (typeof tabulation[survey["title"]][ans_key] === "undefined") {
                                                tabulation[survey["title"]][ans_key] = {
                                                    "question": (q["question"] + " " + opt_text).trim(),
                                                    "values": []
                                                }
                                            }
                                            tabulation[survey["title"]][ans_key]["values"].push(
                                                //"(Q" + qid + ", " + type + ") " +
                                                //q["question"] + " " + opt_text +
                                                //" (A) " + 
                                                answer[k]
                                                // + "<br>"
                                            );

                                            answer_text.push(
                                                "(Q" + qid + ", " + type + ") " +
                                                q["question"] + " " + opt_text +
                                                " (A) " + answer[k] + "<br>"
                                            );
                                        }

                                    }
                                    answer_text.sort();
                                }

                                tbody += "<tr><td>" +
                                    ev_ls["saved_filled_survey_responses"][l]["survey"]["title"] +
                                    "</td><td>" +
                                    answer_text.join(" ") + //JSON.stringify(ev_ls["saved_filled_survey_responses"][l]["response"], null, 4) +
                                    "</td><td>" +
                                    //"<pre>" + JSON.stringify(ev_ls["saved_filled_survey_responses"][l]["response"], null, 4) + "</pre>" +
                                    "-</td><td>" +
                                    //<input value='" + JSON.stringify(ev_ls["saved_filled_survey_responses"][l]["survey"], null, 4) + "'/>" +
                                    "-</td><tr>" +
                                    "";


                            }
                        } else {
                            tbody = "<tr><td>-</td><td></td><td></td><td></td>";
                        }
                        display_str = display_str.replace(/\%count/g, "0");
                        display_str = display_str.replace(/\%tbody/g, tbody);


                        var regen_color_btn = '<a href="#" class="regen_color btn blue-canada-ca lighten-2"><i class="material-icons">refresh</i> Color</a>';
                        display_str += get_template_snip("ls_header")
                            .replace(/\%en/g, "Tabulated Results (Basic)")
                            .replace(/\%fr/g, "Resultats Tabulé (Simple)");

                        display_str += regen_color_btn;
                        var metrics = {};
                        var charts = [];
                        var slices = [];
                        for (var index in tabulation) {
                            metrics = {};
                            display_str += "" + "<div><strong>" + index + "</strong></div>";// + JSON.stringify(tabulation[index]) + "</div><hr>";
                            for (var rindex in tabulation[index]) {
                                metrics = {};
                                slices = [];
                                display_str += "<li><strong>" + rindex + "</strong> <em>" +
                                    tabulation[index][rindex]["question"] +
                                    "</em><br>";
                                for (var t = 0; t < tabulation[index][rindex]["values"].length; t++) {
                                    if (typeof metrics[tabulation[index][rindex]["values"][t]] === "undefined") {
                                        metrics[tabulation[index][rindex]["values"][t]] = 1
                                    } else {
                                        metrics[tabulation[index][rindex]["values"][t]] += 1
                                    }
                                }
                                for (var metric in metrics) {
                                    metrics[metric] = (parseFloat(metrics[metric]) / parseFloat(tabulation[index][rindex]["values"].length));

                                    slices.push(
                                        { percent: metrics[metric], color: randomHsl() }
                                    );
                                    metrics[metric] = (metrics[metric] * 100).toFixed(1) + "%";
                                }
                                charts.push(
                                    {
                                        "chart_id": slugify("" + index + "_" + rindex + "_" + "chart"),
                                        "slices": slices
                                    }
                                );
                                display_str += '<svg class="hnpie" id="' + slugify(index + "_" + rindex + "_" + "chart") + '" viewBox="-1 -1 2 2" style="transform: rotate(-90deg)"></svg>';
                                for (var metric in metrics) {
                                    display_str += " <strong>" + (metric == "" ? "Blank Response" : metric) + "</strong>: " + metrics[metric] + ", ";
                                }
                                display_str += "</li>";
                            }
                            display_str += "<hr>";
                        }
                        //display_str += "" + "<pre>" + JSON.stringify(tabulation, null, 4) + "</pre>";

                        g_state["el"]["c_ls"].html("" +
                            activate_lang(display_str)
                        );
                        $(".adm_load_survey").on("click", function () {
                            ls_load_survey($(this).attr("id"), "sv_sr_");
                        });
                        refresh_lang();
                        for (var i = 0; i < charts.length; i++) {
                            hackernoon_pie(charts[i]["chart_id"], charts[i]["slices"]);
                        }
                        $(".regen_color").on("click", function (e) { e.preventDefault(); ls_show_local_storage(); return false; });

                        //ui_resize_textareas();
                    } else {
                        warn_user_alert();
                    }
                }

                // pull the survey from localstorage and render it
                var ls_load_survey = function (id, trim) {
                    if (ls_storageAvailable('localStorage')) {
                        var ls_index = parseInt(id.replace(trim, ""), 10);
                        var ev_ls = ls_get_lsobject();

                        g_state["el"]["c_editor"].val(
                            ev_ls["saved_survey_signatures"][ls_index]["evalhalla"]
                        );

                        g_state["el"]["c_editor"].trigger("change");
                    } else {
                        warn_user_alert();
                    }
                }

                // clear out the local storage, clean and frush.
                var ls_clear_saved_entries = function () {
                    if (ls_storageAvailable('localStorage')) {
                        localStorage.clear();
                        ls_init_local_storage();
                        g_state["el"]["c_editor"].trigger("change");
                        ls_show_local_storage();
                    } else {
                        warn_user_alert();
                    }
                }
                /*
                This is a peek at what we're saving
                Survista has JSON format to follow, Evalhalla has evalese.
                
                ev_ls = {
                    "working_survey": "", // json source curr survey
                    "saved_survey_signature": [{"survista":{}, "evalhalla": ""}], // array of json src
                    "saved_filled_survey_responses": [{},{}], //array of answerjson + survey sig
                }
                */
                // initialize the local store
                var ls_init_local_storage = function () {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = {
                            "working_survey": {}, // json source curr survey
                            "saved_survey_signatures": [], // array of json src
                            "saved_filled_survey_responses": [], //array of answerjson + survey sig
                        };
                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                    } else {
                        warn_user_alert();
                    }
                }
                // get the string from local store and make it an object for use
                var ls_get_lsobject = function () {
                    var ev_ls = localStorage.getItem('ev_ls');
                    if (ev_ls == null) {
                        ls_init_local_storage();
                        ev_ls = localStorage.getItem('ev_ls');
                    }
                    ev_ls = JSON.parse(ev_ls);
                    return ev_ls;
                }
                // save the question library text into the library
                var ls_save_qlib = function () {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        //console.log(ev_ls);
                        ev_ls["qlib"] = safe($("#qlib").val());
                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                        ls_show_local_storage();
                        update_question_library();
                        ui_resize_textareas();
                    } else {
                        warn_user_alert();
                    }
                }
                // load the question library into the editor
                var ls_load_qlib = function () {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        //console.log(ev_ls);
                        $("#qlib").val(ev_ls["qlib"]);
                        update_question_library();
                    } else {
                        warn_user_alert();
                    }
                }
                // EXEC INIT -- fire the load for the question library
                ls_load_qlib();

                // save the current survey in the editor to the ls
                var ls_save_survey_signature = function (signature, src) {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        //console.log(ev_ls);
                        ev_ls["saved_survey_signatures"].push({ "survista": JSON.parse(signature), "evalhalla": src });
                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                        ls_show_local_storage();
                        ui_resize_textareas();
                    } else {
                        warn_user_alert();
                    }
                }
                // update the local store of the current working survey
                // this allows cross refresh content to remain
                var ls_update_working_survey = function (signature) {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();
                        ev_ls["working_survey"] = JSON.parse(signature);
                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                        //todo: timer on refreshes
                        //ls_show_local_storage();
                        ui_resize_textareas();
                    } else {
                        warn_user_alert();
                    }
                }

                // registhor api integrations. Testing route
                const rg_api_route = api_post_surv_resp_route + api_key;
                // survista:eval api integrations
                const sv_api_route = sv_api_post_surv_resp_route + sv_api_key;
                // post the currently rendered survey response to the api
                var api_post_to_route = function (route, data_in) {
                    $.ajax({
                        url: route,
                        contentType: "application/json",
                        type: "POST",
                        data: data_in,
                        success: function (response) {
                            console.log(response);
                        }
                    });
                }
                // upload the survey reponse to our integrations
                var api_upload_survey_result = function (data_in) {
                    //console.log(data_in);
                    let api_route = "";
                    api_route = sv_api_route;
                    api_post_to_route(api_route, data_in);
                    api_route = rg_api_route;
                    api_post_to_route(api_route, data_in);
                }
                // save the survey response into the local store. allows for offline storage for upload later
                // TODO: upload later function
                var ls_save_survey_response = function (response) {
                    if (ls_storageAvailable('localStorage')) {
                        var ev_ls = ls_get_lsobject();

                        ev_ls["saved_filled_survey_responses"].push(
                            {
                                "response": JSON.parse(response),
                                "survey": ev_ls["working_survey"]
                            }
                        );

                        localStorage.setItem('ev_ls', JSON.stringify(ev_ls));
                        ls_show_local_storage();
                        ui_resize_textareas();

                        // submit to api
                        // TODO: turn back on
                        //api_upload_survey_result(response);

                        // clear responses
                        // TODO: reinit tombstone generics, refactor needed
                        g_state["generics"]["generic_fetched"] = false;
                        api_get_generics();
                        g_state["el"]["c_editor"].trigger("change");
                    } else {
                        warn_user_alert();
                    }
                }
                var ls_view_saved_entries = function () {
                    if (ls_storageAvailable('localStorage')) {
                        ls_show_local_storage();
                    } else {
                        warn_user_alert();
                    }
                }

                //
                // State Controls
                //
                // this is a the app state object. it hold a bunch of info to help optimize things
                // the jquery selectors are stored here so we can refactor easier and hopefully 
                // speed things up.

                // app state details, ui, handle to jq elems
                const g_state = {
                    // tutorial script vars
                    "tut": {
                        "type_it": g_tutorial_script.split(""),
                        "type_it_short": g_shorthand_script.split(""),
                        "type_it_short_fr": g_shorthand_script_fr.split(""),
                        "char_at": 0,
                        "typer": null,
                    },
                    // question library
                    "qlib": [],
                    // tombstone information
                    "tombstone": {
                        "offering_id": "",
                        "department": "",
                        "classification": "",
                        "city": ""
                    },
                    // generics (refactor)
                    "generics": {
                        "generic_fetched": false,
                        "ev_inline_dept": "",
                        "ev_inline_role": "",
                        "ev_inline_region": "",
                        "ev_inline_office": ""
                    },
                    // ui window state (for hide show)
                    "ui": {
                        "lang": "en",
                        "hs_editor_window": false,
                        "hs_json_window": false,
                        "hs_render_window": false,
                        "hs_ls_window": false,
                        "hs_qlib_window": false
                    },
                    // elements, jquery selectors
                    "el": {
                        // lang
                        "lang": $(".lang"),
                        "lang_set_en": $(".lang-set-en"),
                        "lang_set_fr": $(".lang-set-fr"),
                        "en": $(".en"),
                        "fr": $(".fr"),
                        // buttons
                        "btn_upload": $(".survista_send"),
                        "btn_tutorial": $(".show_me_how"),
                        "btn_tutorial_short": $(".show_me_how_short"),
                        "btn_hs_editor": $(".hs_editor_window"),
                        "btn_hs_json": $(".hs_json_window"),
                        "btn_hs_render": $(".hs_render_window"),
                        "btn_hs_ls": $(".hs_ls_window"),
                        "btn_hs_qlib": $(".hs_qlib_window"),
                        "btn_audit": $(".audit_json_render"),
                        // admin buttons
                        "adm_clear_ls": $(".adm_clear_ls"),
                        "adm_save_working_survey": $(".adm_save_working_survey"),
                        // add cmms editor
                        "edt_erase": $(".ev-add-erase"),
                        "edt_header": $(".ev-add-header"),
                        "edt_instr": $(".ev-add-instr"),
                        "edt_qany": $(".ev-add-qany"),
                        "edt_qfree": $(".ev-add-qfree"),
                        "edt_qone": $(".ev-add-qone"),
                        "edt_qrank": $(".ev-add-qrank"),
                        "edt_qscale": $(".ev-add-qscale"),
                        // content
                        "c_editor": $("#editor_target"),
                        "c_json": $("#json_target"),
                        "c_render": $("#render_target"),
                        "c_ls": $("#ls_target"),
                        // ui panels
                        "ui_editor": $("#editor_window"),
                        "ui_json": $("#json_window"),
                        "ui_render": $("#render_window"),
                        "ui_ls": $("#ls_window"),
                        "ui_qlib": $("#qlib_window")
                    }
                };

                // Evalese parser state, headers, questions, json
                // used for generation of html form
                var g_control_flags = {
                    "json": "{}",
                    "pageid": 1,
                    "currpageid": 1,
                    "header": {
                        "survey": false,
                        "title": false,
                        "intro": false
                    },
                    "header_json": {
                        "survey": false,
                        "title": false,
                        "intro": false
                    },
                    "question": {
                        "text": false,
                        "qid": 0,
                        "form": false,
                        "random": {
                            "order": false,
                            "options": false
                        },
                        "required": false
                    }
                }
                // reset the control flags after each successful chunk processing
                // hard means a new survey. This is usually triggered when we get 
                // a new survey header
                var reset_control_flags = function (hard = false) {
                    g_control_flags["question"] = {
                        "text": false,
                        "qid": 0,
                        "form": false,
                        "random": {
                            "order": false,
                            "options": false
                        },
                        "required": false
                    };
                    g_control_flags["json"] = "{}";
                    g_control_flags["pageid"] = 1;
                    g_control_flags["currpageid"] = 1;
                    if (hard == true) {
                        g_control_flags["header"] = {
                            "survey": "",
                            "title": "",
                            "intro": ""
                        };
                    }
                }


                //
                // Helper functions
                //

                // get from tombstone: stub
                // TODO: Refactor Fix with correct code (right now just obj/deobj for test)
                g_state["generics"]["generic_fetched"] = false;

                // REGISTHOR INTEGRATION autocomplete load classifications from registhor
                var autoc_load_classifications = function (api_load = false) {
                    if (api_load == true) {
                        $.ajax({
                            url: api_get_classifications_route + api_key,
                            contentType: "application/json",
                            type: "GET",
                            //data: data_in,
                            success: function (response) {
                                g_state["generics"]["classifications"] = typeof response.results !== "undefined" ? response.results : [];
                                var autoc_json = {}
                                for (var i = 0; i < g_state["generics"]["classifications"].length; i++) {
                                    autoc_json[g_state["generics"]["classifications"][i]] = null;
                                }
                                g_state["generics"]["classifications"] = autoc_json;
                                $('.tombstone_classification').autocomplete({
                                    data: g_state["generics"]["classifications"]
                                });
                            }
                        });
                    } else {
                        g_state["generics"]["classifications"] = typeof autoc_classifications !== "undefined" ? autoc_classifications : [];
                        var autoc_json = {}
                        for (var i = 0; i < g_state["generics"]["classifications"].length; i++) {
                            autoc_json[g_state["generics"]["classifications"][i]] = null;
                        }
                        g_state["generics"]["classifications"] = autoc_json;
                        $('.tombstone_classification').autocomplete({
                            data: g_state["generics"]["classifications"]
                        });
                    }
                }
                autoc_load_classifications();

                // REGISTHOR INTEGRATION autocomplete load departments from registhor
                // local js options are the default to reduce api call load
                var autoc_load_departments = function (api_load = false) {
                    if (api_load == true) {
                        $.ajax({
                            url: api_get_departments_route + api_key,
                            contentType: "application/json",
                            type: "GET",
                            //data: data_in,
                            success: function (response) {
                                g_state["generics"]["department_en"] = typeof response.results !== "undefined" ? response.results : [];
                                var autoc_json = {}
                                for (var i = 0; i < g_state["generics"]["department_en"].length; i++) {
                                    autoc_json[g_state["generics"]["department_en"][i]] = null;
                                }
                                g_state["generics"]["department_en"] = autoc_json;
                                $('.tombstone_department').autocomplete({
                                    data: g_state["generics"]["department_en"]
                                });
                            }
                        });
                        $.ajax({
                            url: api_get_departments_route_fr + api_key,
                            contentType: "application/json",
                            type: "GET",
                            //data: data_in,
                            success: function (response) {
                                g_state["generics"]["department_fr"] = typeof response.results !== "undefined" ? response.results : [];
                                var autoc_json = {}
                                for (var i = 0; i < g_state["generics"]["department_fr"].length; i++) {
                                    autoc_json[g_state["generics"]["department_fr"][i]] = null;
                                }
                                g_state["generics"]["department_fr"] = autoc_json;
                                // TODO: Merge the two dept arrays
                                $('.tombstone_department_fr').autocomplete({
                                    data: g_state["generics"]["department_fr"]
                                });
                            }
                        });
                    } else {
                        g_state["generics"]["department_en"] = typeof autoc_departments !== "undefined" ? autoc_departments : [];
                        var autoc_json = {}
                        for (var i = 0; i < g_state["generics"]["department_en"].length; i++) {
                            autoc_json[g_state["generics"]["department_en"][i]] = null;
                        }
                        g_state["generics"]["department_en"] = autoc_json;
                        $('.tombstone_department').autocomplete({
                            data: g_state["generics"]["department_en"]
                        });
                    }
                }
                autoc_load_departments();

                // REGISTHOR INTEGRATION autocomplete load cities from registhor
                // local js options are the default to reduce api call load
                var autoc_load_cities = function (api_load = false) {
                    if (api_load == true) {
                        $.ajax({
                            url: api_get_cities_route + api_key,
                            contentType: "application/json",
                            type: "GET",
                            //data: data_in,
                            success: function (response) {
                                g_state["generics"]["cities_en"] = typeof response.results !== "undefined" ? response.results : [];
                                var autoc_json = {}
                                for (var i = 0; i < g_state["generics"]["cities_en"].length; i++) {
                                    autoc_json[g_state["generics"]["cities_en"][i]] = null;
                                }
                                g_state["generics"]["cities_en"] = autoc_json;
                                $('.tombstone_city').autocomplete({
                                    data: g_state["generics"]["cities_en"]
                                });
                            }
                        });
                        $.ajax({
                            url: api_get_cities_route_fr + api_key,
                            contentType: "application/json",
                            type: "GET",
                            //data: data_in,
                            success: function (response) {
                                g_state["generics"]["cities_fr"] = typeof response.results !== "undefined" ? response.results : [];
                                var autoc_json = {}
                                for (var i = 0; i < g_state["generics"]["cities_fr"].length; i++) {
                                    autoc_json[g_state["generics"]["cities_fr"][i]] = null;
                                }
                                g_state["generics"]["cities_fr"] = autoc_json;
                                $('.tombstone_city_fr').autocomplete({
                                    data: g_state["generics"]["cities_fr"]
                                });
                            }
                        });
                    } else {
                        g_state["generics"]["cities_en"] = typeof autoc_cities !== "undefined" ? autoc_cities : [];
                        var autoc_json = {}
                        for (var i = 0; i < g_state["generics"]["cities_en"].length; i++) {
                            autoc_json[g_state["generics"]["cities_en"][i]] = null;
                        }
                        g_state["generics"]["cities_en"] = autoc_json;
                        $('.tombstone_city').autocomplete({
                            data: g_state["generics"]["cities_en"]
                        });
                    }
                }
                autoc_load_cities();

                // refactor
                // pull default values into the generics for demonstration
                var api_get_generics = function () {
                    if (g_state["generics"]["generic_fetched"] == false) {
                        //M.toast({ html: "Found this gc data, prefilling...", classes: 'rounded' });
                        console.info("Found this gc data, prefilling...")
                        g_state["generics"]["ev_inline_dept"] = "CSPS-EFPC";
                        g_state["generics"]["ev_inline_role"] = "CS-04";
                        g_state["generics"]["ev_inline_region"] = "NCR";
                        g_state["generics"]["ev_inline_office"] = "Bayview";
                        g_state["generics"]["generic_fetched"] = true;
                    }
                };
                // TODO: init tombstone generics
                //api_get_generics();

                // shuffles an array. So you can randomize things.
                const shuffle_array = function (array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                };

                // returns the query string as an object. 
                // NOTE: Need to protect against injection/XSS
                const get_params_as_object = function (query) {
                    query = query.substring(query.indexOf('?') + 1);
                    var re = /([^&=]+)=?([^&]*)/g;
                    var decodeRE = /\+/g;

                    var decode = function (str) {
                        return safe(decodeURIComponent(str.replace(decodeRE, " ")));
                    };

                    var params = {}, e;
                    while (e = re.exec(query)) {
                        var k = decode(e[1]), v = decode(e[2]);
                        if (k.substring(k.length - 2) === '[]') {
                            k = k.substring(0, k.length - 2);
                            (params[k] || (params[k] = [])).push(v);
                        }
                        else params[k] = v;
                    }

                    var assign = function (obj, keyPath, value) {
                        var lastKeyIndex = keyPath.length - 1;
                        for (var i = 0; i < lastKeyIndex; ++i) {
                            var key = keyPath[i];
                            if (!(key in obj))
                                obj[key] = {}
                            obj = obj[key];
                        }
                        obj[keyPath[lastKeyIndex]] = value;
                    }

                    for (var prop in params) {
                        var structure = prop.split('[');
                        if (structure.length > 1) {
                            var levels = [];
                            structure.forEach(function (item, i) {
                                var key = item.replace(/[?[\]\\ ]/g, '');
                                levels.push(key);
                            });
                            assign(params, levels, params[prop]);
                            delete (params[prop]);
                        }
                    }
                    return params;
                };

                // auto reset the form if enough time has passed
                // NOTE: Accessibility concerns here
                const activate_restart_timer = function () {
                    //TODO: 20 sec delay restart
                };

                // submit the form result
                const evalhalla_submit = function () {
                    // make some form data
                    var formElement = document.getElementById("evalhalla_form");
                    var formData = new FormData(formElement);
                    console.log(formData);
                    // can use that to post
                    // query string would be
                    var query_string = $("#evalhalla_form").serialize();
                    console.log(query_string);
                    if (formElement.checkValidity() == true) {
                        //alert("Good to go!");
                    } else {
                        alert("Missing Data");
                        $(".ev-page").show();
                        formElement.checkValidity()
                        return;
                    }
                    // let em know
                    var json_o = get_params_as_object(query_string);

                    // get tombstone details
                    // TODO: Sanitize inputs
                    json_o["tombstone_department"] = safe($("#autocomplete-input-department").val());
                    json_o["tombstone_city"] = safe($("#autocomplete-input-city").val());
                    json_o["tombstone_classification"] = safe($("#autocomplete-input-classification").val());
                    json_o["tombstone_offering_id"] = safe(g_state["tombstone"]["offering_id"]);
                    json_o["tombstone_language"] = safe(g_state["ui"]["lang"]);

                    var json_o_string = (JSON.stringify(json_o, null, 4));
                    // save response to local storage
                    ls_save_survey_response(json_o_string);
                    // show local storage items
                    ls_view_saved_entries();
                    //alert(json_o_string);
                    g_state["el"]["ui_render"].hide();
                    $("#step_thank_you_cta").show();
                    activate_restart_timer();
                    //alert("Check the console for details");
                };

                // convert the en/fr tags into HTML
                const activate_lang = function (pack) {
                    pack = pack
                        .replace(/\/en/g, "<span class='en'>")
                        .replace(/\/fr/g, "<span class='fr'>")
                        .replace(/\/\;/g, "</span>")
                        .replace(/\/\;\/en/g, "</span><span class='en'>")
                        .replace(/\/\;\/fr/g, "</span><span class='fr'>")
                        .replace(/\;\/en/g, "</span><span class='en'>")
                        .replace(/\;\/fr/g, "</span><span class='fr'>")
                        ;
                    return pack;
                };

                // helper function to take the multiline input and pack it into one object
                const pack_text = function (src_a, i, pack, join = " ") {
                    var nextcmd = "null";
                    var pack_json = "";
                    while (nextcmd == "null") {
                        if (i + 1 < src_a.length) {
                            nextcmd = detect_command(src_a[i + 1]);
                            if (nextcmd == "null") {
                                //pack += join + "[en] " + src_a[i + 1] + " [fr] " + src_a[i + 1];
                                pack += join + src_a[i + 1];
                                i++;
                            } else {
                                // do nothing
                            }
                        } else {
                            nextcmd = "exit";
                        }
                    }
                    // Q: the test
                    // Q: /en the test
                    // Q: /fr le test
                    // Q: /en the test /fr le test
                    // TODO note: this/entails could be an issue
                    pack_json = pack;

                    pack = activate_lang(pack); // adds in the <span> s

                    return { "pack": pack, "pack_json": pack_json, "i": i };
                }

                // materialize css resize the textareas so it shows content instead
                // of remaining the previous size
                var ui_resize_textareas = function () {
                    M.textareaAutoResize(g_state["el"]["c_editor"]);
                    M.textareaAutoResize(g_state["el"]["c_json"]);
                }

                //
                // Command Handlers
                //

                // parser - detect if we have encountered a command
                var detect_command = function (src) {
                    var first_word = src.split(" ")[0];
                    if (first_word == "" || typeof first_word === "undefined") {
                        return "null";
                    } else if (first_word == "\n") {
                        return "newline";
                    } else if (typeof g_cmd[first_word.toUpperCase().trim()] !== "undefined") {
                        return g_cmd[first_word.toUpperCase().trim()];
                    }
                    return "null";
                }
                // parser - handle the header command
                var handle_cmd_header = function (cmd, src, json = "") {
                    reset_control_flags();

                    g_control_flags["header"][cmd] = src.replace(src.split(" ")[0], "").trim();
                    g_control_flags["header_json"][cmd] = json.replace(json.split(" ")[0], "").trim();
                    // handle html
                    var snip = get_template_snip("header");
                    snip = snip.replace(/\%title/g, g_control_flags["header"]["title"]);
                    snip = snip.replace(/\%survey/g, g_control_flags["header"]["survey"]);
                    snip = snip.replace(/\%intro/g, g_control_flags["header"]["intro"]);
                    // handle json
                    var jsonsnip = get_template_snip("header", "json");
                    jsonsnip = jsonsnip.replace(/\%title/g, g_control_flags["header_json"]["title"]);
                    jsonsnip = jsonsnip.replace(/\%survey/g, g_control_flags["header_json"]["survey"]);
                    jsonsnip = jsonsnip.replace(/\%intro/g, g_control_flags["header_json"]["intro"]);
                    g_control_flags["json"] = jsonsnip;


                    return snip;
                }

                // parser - handle the pagebreak command
                var handle_cmd_pagebreak = function (cmd, src, json = "") {
                    // handle html
                    var snip = get_template_snip("page break");
                    g_control_flags["pageid"] = g_control_flags["pageid"] + 1;
                    snip = snip.replace(/\%pageid/g, g_control_flags["pageid"]);
                    // handle json
                    var jsonsnip = get_template_snip("page break", "json");
                    jsonsnip = jsonsnip.replace(/\%instruction/g, json.replace(json.split(" ")[0], "").trim());
                    g_control_flags["json"] = g_control_flags["json"]
                        .replace("%questions", jsonsnip + ",%questions")
                    return snip;
                }

                // parser - handle the instruction command
                var handle_cmd_instruction = function (cmd, src, json = "") {
                    // handle html
                    var snip = get_template_snip("instruction");
                    snip = snip.replace(/\%instruction/g, src.replace(src.split(" ")[0], "").trim());
                    // handle json
                    var jsonsnip = get_template_snip("instruction", "json");
                    jsonsnip = jsonsnip.replace(/\%instruction/g, json.replace(json.split(" ")[0], "").trim());
                    g_control_flags["json"] = g_control_flags["json"]
                        .replace("%questions", jsonsnip + ",%questions")
                        .replace("%rand_order", g_control_flags["question"]["random"]["order"])
                        .replace("%rand_options", g_control_flags["question"]["random"]["options"])
                        .replace("%lang", g_state["ui"]["lang"])
                        ;
                    return snip;
                }

                // parser - handle the question command
                var handle_cmd_question = function (cmd, src, json = "") {
                    var snip = get_template_snip("question");
                    if (cmd == "question" || cmd == "req question") {
                        // handle html
                        g_control_flags["question"]["text"] = src.replace(src.split(" ")[0], "").trim();
                        g_control_flags["question"]["qid"] = g_control_flags["question"]["qid"] + 1;
                        snip = snip.replace(/\%question/g, g_control_flags["question"]["text"]);
                        snip = snip.replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        if (cmd == "req question") {
                            snip = snip.replace(/\%req/g, '<span class="badge red white-text"><span class="en">required</span><span class="fr">requis</span></span>');
                        } else {
                            snip = snip.replace(/\%req/g, '');
                        }
                        g_control_flags["question"]["form"] = snip;
                        // handle json
                        var jsonsnip = get_template_snip("question", "json");
                        g_control_flags["question"]["text"] = json.replace(json.split(" ")[0], "").trim()
                        jsonsnip = jsonsnip.replace(/\%question/g, g_control_flags["question"]["text"]);
                        jsonsnip = jsonsnip.replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        g_control_flags["json"] = g_control_flags["json"]
                            .replace("%questions", jsonsnip + ",%questions")
                            .replace("%rand_order", g_control_flags["question"]["random"]["order"])
                            .replace("%rand_options", g_control_flags["question"]["random"]["options"])
                            ;
                        if (cmd == "req question") {
                            g_control_flags["question"]["required"] = true;
                            g_control_flags["json"] = g_control_flags["json"]
                                .replace("%req", "true");
                        } else {
                            g_control_flags["question"]["required"] = false;
                            g_control_flags["json"] = g_control_flags["json"]
                                .replace("%req", "false");
                        }
                    } else if (cmd == "scale") {
                        // handle html
                        snip = g_control_flags["question"]["form"];
                        var scale = get_template_snip("scale").replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        var opts = src.split(",")
                        // clean opts
                        opts[0] = opts[0]
                            .replace("[SCALE]", "")
                            .replace(/(\/SCALE|\/scale)/g, "")
                            .replace(/(\/ÉCHELLE|\/échelle)/g, "")
                            .replace("|", "")
                            .trim();
                        // handle json
                        var jsonsnip = get_template_snip("scale", "json");
                        jsonsnip = jsonsnip.replace(/\%qid/g, g_control_flags["question"]["qid"]);
                        g_control_flags["json"] = g_control_flags["json"].replace(/\%type/g, "dropdown");

                        for (var opti = 0; opti < opts.length; opti++) {
                            if (opti == 0) {
                                scale = scale.replace(/\%low/g, opts[opti]);
                                jsonsnip = jsonsnip.replace(/\%low/g, opts[opti].trim());
                            } else if (opti == 1) {
                                scale = scale.replace(/\%high/g, opts[opti]);
                                jsonsnip = jsonsnip.replace(/\%high/g, opts[opti].trim());
                            } else if (opti == 2) {
                                scale = scale.replace(/\%unsure/g, opts[opti]);
                                jsonsnip = jsonsnip.replace(/\%unsure/g, opts[opti].trim());
                            }
                            else {
                                // do nothing
                            }
                        }
                        // cleanup unused replacement symbol targets
                        scale = scale.replace(/\%low/g, "")
                            .replace(/\%high/g, "")
                            .replace(/\%unsure/g, "");
                        jsonsnip = jsonsnip.replace(/\%low/g, "")
                            .replace(/\%high/g, "")
                            .replace(/\%unsure/g, "");

                        g_control_flags["json"] = g_control_flags["json"].replace("%options", jsonsnip);
                        snip = snip.replace(/\%form/g, scale);
                        if (g_control_flags["question"]["required"] == true) {
                            snip = snip.replace(/\%reqattr/g, 'required="" aria-required="true"').replace(/\%reqcls/g, "validate");
                        } else {
                            snip = snip.replace(/\%reqattr/g, '').replace(/\%reqcls/g, "");
                        }
                        g_control_flags["question"]["form"] = snip;
                    } else if (cmd == "open") {
                        //required="" aria-required="true" class="validate"
                        // handle html
                        snip = g_control_flags["question"]["form"];
                        snip = snip.replace(/\%form/g,
                            get_template_snip("open")
                                .replace(/\%qid/g, g_control_flags["question"]["qid"])
                        );
                        if (g_control_flags["question"]["required"] == true) {
                            snip = snip.replace(/\%reqattr/g, 'required="" aria-required="true"').replace(/\%reqcls/g, "validate");
                        } else {
                            snip = snip.replace(/\%reqattr/g, '').replace(/\%reqcls/g, "");
                        }
                        g_control_flags["question"]["form"] = snip;
                        // handle json
                        g_control_flags["json"] = g_control_flags["json"].replace("%options", "").replace(/\%type/g, "text");
                    } else if (cmd == "generics") {
                        // handle html
                        snip = g_control_flags["question"]["form"];
                        snip = snip.replace(/\%form/g, get_template_snip("generics").replace(/\%qid/g, g_control_flags["question"]["qid"]));
                        if (g_control_flags["question"]["required"] == true) {
                            snip = snip.replace(/\%reqattr/g, 'required="" aria-required="true"').replace(/\%reqcls/g, "validate");
                        } else {
                            snip = snip.replace(/\%reqattr/g, '').replace(/\%reqcls/g, "");
                        }
                        g_control_flags["question"]["form"] = snip;
                        // todo: handle json
                        g_control_flags["json"] = g_control_flags["json"].replace("%options", '"dept","role","region","office"').replace(/\%type/g, "text");
                    } else if (cmd == "pick one" || cmd == "pick any" || cmd == "rank") {
                        snip = g_control_flags["question"]["form"];
                        var opts = src.split("[OPT]")
                        opts.shift(); // remove first null item

                        var opts_json = json.split("[OPT]")
                        opts_json.shift(); // remove first null item

                        var form = "";
                        var jsonsnip = '';
                        // handle html+json same time
                        var random_shuffle = [];
                        var temp_snip = "";
                        // lang opt check for bilingual
                        var opt_input_value = ""
                        for (var opti = 0; opti < opts.length; opti++) {
                            //
                            // WARN: Brittle code. Tied to HTML structure.
                            // See pack_text, activate_lang
                            // suggest holding off on activate_lang until form is fully built
                            // also, address the JSON render (it will have evalese in the mix)
                            // 
                            opt_input_value = opts[opti].trim()
                            var oa = [];
                            oa = opt_input_value.split("</span>")
                            for (var m = 0; m < oa.length; m++) {
                                if (oa[m].indexOf("<span class='" + g_state["ui"]["lang"] + "'>") !== -1) {
                                    opt_input_value = oa[m].replace("<span class='" + g_state["ui"]["lang"] + "'>", "");
                                }
                            }
                            // end WARN

                            temp_snip = get_template_snip(cmd)
                                .replace(/\%qid/g, g_control_flags["question"]["qid"])
                                .replace(/\%pick/g, opts[opti].trim())
                                .replace(/\%oid/g, opti)
                                .replace(/\%vpick/g, opt_input_value.trim())
                                ;
                            form += temp_snip;
                            random_shuffle.push(temp_snip);

                            jsonsnip += "," + get_template_snip(cmd, "json")
                                .replace(/\%pick/g, opts_json[opti].trim());
                        }
                        if (g_control_flags["question"]["random"]["options"] == true) {
                            shuffle_array(random_shuffle);
                            form = random_shuffle.join(" ");
                        }
                        if (typeof snip !== "undefined" && snip != false) {
                            if (cmd == "pick one" || cmd == "pick any") {
                                snip = snip.replace(/\%form/g, `<fieldset>${form}</fieldset>`);
                            } else {
                                snip = snip.replace(/\%form/g, form);
                            }
                        }

                        if (g_control_flags["question"]["required"] == true) {
                            snip = snip.replace(/\%reqattr/g, 'required="" aria-required="true"').replace(/\%reqcls/g, "validate");
                        } else {
                            snip = snip.replace(/\%reqattr/g, '').replace(/\%reqcls/g, "");
                        }
                        g_control_flags["question"]["form"] = snip;
                        // handle json
                        g_control_flags["json"] = g_control_flags["json"].replace(/\%type/g, "mcq");
                        g_control_flags["json"] = g_control_flags["json"].replace("%options", jsonsnip
                            .replace(/(^[,\s]+)|([,\s]+$)/g, ''));
                    }
                    // TODO: Lang override, replace with actual language control
                    g_control_flags["json"] = g_control_flags["json"].replace(/\%lang/g, g_state["ui"]["lang"]);

                    return snip;
                }

                //
                // Main proc loop
                //

                // start parsing the input
                var raise_src_to_evalhalla = function (src) {
                    var src_a = src.split("\n");
                    var i = 0;
                    var evalhalla = [];
                    var cmd = "";

                    for (i = 0; i < src_a.length; i++) {
                        cmd = detect_command(src_a[i]);
                        if (cmd != "null") {
                            if (
                                cmd["type"] == "survey"
                                || cmd["type"] == "intro"
                                || cmd["type"] == "title"
                            ) {
                                var pack = src_a[i];
                                //if (cmd["type"] == "intro") {
                                var pkg = pack_text(src_a, i, pack);
                                pack = pkg["pack"];
                                i = pkg["i"];
                                //}
                                evalhalla = [handle_cmd_header(cmd["type"], pack, pkg["pack_json"])];
                            } else if (cmd["type"] == "question" || cmd["type"] == "req question"
                                || cmd["type"] == "scale"
                                || cmd["type"] == "open"
                                || cmd["type"] == "generics"
                                || cmd["type"] == "pick one"
                                || cmd["type"] == "pick any"
                                || cmd["type"] == "rank"
                            ) {
                                var pack = src_a[i];
                                var pkg = (
                                    cmd["type"] == "pick one"
                                    || cmd["type"] == "pick any"
                                    || cmd["type"] == "rank"
                                ) ? pack_text(src_a, i, pack, "[OPT] ") : pack_text(src_a, i, pack);
                                pack = pkg["pack"];
                                i = pkg["i"];

                                if (cmd["type"] == "scale"
                                    || cmd["type"] == "open"
                                    || cmd["type"] == "generics"
                                    || cmd["type"] == "pick one"
                                    || cmd["type"] == "pick any"
                                    || cmd["type"] == "rank") {
                                    evalhalla.pop();
                                    g_state["qlib"].pop();
                                }
                                evalhalla.push(handle_cmd_question(cmd["type"], pack, pkg["pack_json"]));
                                g_state["qlib"].push(pack);
                            } else if (cmd["type"] == "instruction") {
                                var pack = src_a[i];
                                var pkg = pack_text(src_a, i, pack);
                                pack = pkg["pack"];
                                i = pkg["i"];
                                evalhalla.push(handle_cmd_instruction(cmd["type"], pack, pkg["pack_json"]));
                            } else if (cmd["type"] == "page break") {
                                var pack = src_a[i];
                                var pkg = pack_text(src_a, i, pack);
                                pack = pkg["pack"];
                                i = pkg["i"];
                                evalhalla.push(handle_cmd_pagebreak(cmd["type"], pack, pkg["pack_json"]));
                            } else if (cmd["type"] == "random order" || cmd["type"] == "end random order") {
                                // handle randomize order
                                if (cmd["type"] == "random order") {
                                    g_control_flags["question"]["random"]["order"] = true;
                                } else if (cmd["type"] == "end random order") {
                                    g_control_flags["question"]["random"]["order"] = false;
                                }
                            } else if (cmd["type"] == "random options" || cmd["type"] == "end random options") {
                                // handle random options
                                if (cmd["type"] == "random options") {
                                    g_control_flags["question"]["random"]["options"] = true;
                                } else if (cmd["type"] == "end random options") {
                                    g_control_flags["question"]["random"]["options"] = false;
                                }
                            } else if (cmd["type"] == "end") {
                                // handle generic end, custom for random
                            } else if (cmd["type"] == "end pick" || cmd["type"] == "end rank") {
                                // skip end tag for now
                            } else {
                                // generic handler, use basic tag wrapping from g_cmd
                                evalhalla.push(cmd["html"].replace(/\%v/g, src_a[i]));
                            }
                        }
                    }
                    // random order handling
                    var return_evalhalla = "";
                    try {
                        var new_evalhalla = [];
                        var new_evalhalla_rand = [];
                        var q_index = JSON.parse(g_control_flags["json"]
                            .replace(/\,\%questions/g, "")
                            .replace(/\%options/g, "")
                            .replace(/\%questions/g, "")
                        );
                        var qs = q_index["questions"];
                        new_evalhalla.push(evalhalla[0]);

                        if (typeof qs !== "undefined") {
                            for (var k = 0; k < qs.length; k++) {
                                if (qs[k].randomOrder == "false") {
                                    if (new_evalhalla_rand.length != 0) {
                                        shuffle_array(new_evalhalla_rand);
                                        new_evalhalla.push(new_evalhalla_rand.join(""));
                                        new_evalhalla_rand = [];
                                    }
                                    new_evalhalla.push(evalhalla[k + 1]);
                                } else {
                                    new_evalhalla_rand.push(evalhalla[k + 1]);
                                }
                            }
                        }
                        shuffle_array(new_evalhalla_rand);
                        new_evalhalla.push(new_evalhalla_rand.join());
                        new_evalhalla_rand = [];
                        return_evalhalla = new_evalhalla.join("");
                    } catch (e) {
                        return_evalhalla = evalhalla.join("");
                        //M.toast({ html: 'JSON ' + e.toString(), classes: 'rounded' });
                    }


                    // save current survey signature
                    ls_update_working_survey(g_control_flags["json"]
                        .replace(/\,\%questions/g, "")
                        .replace(/\%options/g, "")
                        .replace(/\%questions/g, ""));

                    return return_evalhalla
                        .replace(/\,\%questions/g, "")
                        .replace(/\%options/g, "")
                        .replace(/\%questions/g, "")
                };

                // 
                // Material UI General
                //

                $(".sidenav").sidenav();
                $(".parallax").parallax();
                $('.fixed-action-btn').floatingActionButton();
                $('.modal').modal();
                $(".dropdown-trigger").dropdown();

                //
                // Non-Material UI general
                //


                $(".update_ls").on("click", function (e) { e.preventDefault(); ls_show_local_storage(); return false; });

                // TODO: refactor. tombstone generic info
                var refresh_generics = function () {
                    //alert("Refreshing Generic");

                    api_get_generics();

                    $(".ev_inline_dept").val(g_state["generics"]["ev_inline_dept"]);
                    $(".ev_inline_role").val(g_state["generics"]["ev_inline_role"]);
                    $(".ev_inline_region").val(g_state["generics"]["ev_inline_region"]);
                    $(".ev_inline_office").val(g_state["generics"]["ev_inline_office"]);

                    $(".ev_inline_dept").on("change", function () { g_state["generics"]["ev_inline_dept"] = safe($(this).val()); });
                    $(".ev_inline_role").on("change", function () { g_state["generics"]["ev_inline_role"] = safe($(this).val()); });
                    $(".ev_inline_region").on("change", function () { g_state["generics"]["ev_inline_region"] = safe($(this).val()); });
                    $(".ev_inline_office").on("change", function () { g_state["generics"]["ev_inline_office"] = safe($(this).val()); });

                    M.updateTextFields();
                };

                // lang refresh to show the new language spans
                var refresh_lang = function () {
                    if (g_state["ui"]["lang"] == "en") {
                        $("span.en").show();
                        $("span.fr").hide();
                    } else if (g_state["ui"]["lang"] == "fr") {
                        $("span.en").hide();
                        $("span.fr").show();
                    }
                    ui_resize_textareas();
                };
                // language buttons
                g_state["el"]["lang"].on("click", function () {
                    if (g_state["ui"]["lang"] == "en") {
                        g_state["ui"]["lang"] = "fr";
                        refresh_lang();
                        //ui_resize_textareas();
                        $(".dropdown-trigger").dropdown();
                    } else if (g_state["ui"]["lang"] == "fr") {
                        g_state["ui"]["lang"] = "en";
                        refresh_lang();
                        //ui_resize_textareas();
                        $(".dropdown-trigger").dropdown();
                    }
                });
                g_state["el"]["lang_set_fr"].on("click", function () {
                    g_state["ui"]["lang"] = "fr";
                    refresh_lang();
                    //ui_resize_textareas();
                    $(".dropdown-trigger").dropdown();
                    $("#step_lang").hide();
                    $("#step_offering").show();
                });
                g_state["el"]["lang_set_en"].on("click", function () {
                    g_state["ui"]["lang"] = "en";
                    refresh_lang();
                    //ui_resize_textareas();
                    $(".dropdown-trigger").dropdown();
                    $("#step_lang").hide();
                    $("#step_offering").show();
                });
                // step advance - tomstone information set
                $(".tombstone-set").on("click", function () {
                    $("#step_tombstone").hide();
                    g_state["el"]["ui_render"].show();
                });
                // step advance - ready for next partipant step
                $(".ev-ready-for-next").on("click", function () {
                    $("#step_thank_you_cta").hide();
                    $("#step_lang").show();
                    $("#autocomplete-input-department").val("");
                    $("#autocomplete-input-city").val("");
                    $("#autocomplete-input-classification").val("");
                });

                // uncomment to generate on load
                //g_state["el"]["lang"].trigger("change");

                // load intro content
                g_state["el"]["c_editor"].val(
                    g_intro_script
                );

                // 
                // Question Library
                //

                $("#qlib").on("change", function () {
                    update_question_library();
                    ls_save_qlib();
                });
                $("#qlib").trigger("change");

                // Render Trigger
                // Render Timer additions. TODO: Causes flicker of submit. Adjust setting classes.
                var render_buffering = false;
                var render_manager = null;
                var render_delay = 1300; // 1.3 sec delay between renders
                var render_requested = false;
                g_state["el"]["c_editor"].on("change keyup", function () {
                    // render timer
                    if (render_buffering == true) {
                        render_requested = true;
                        return false;
                    } else {
                        render_buffering = true;
                        render_manager = setTimeout(function () {
                            render_buffering = false;
                            if (render_requested == true) {
                                render_requested = false;
                                g_state["el"]["c_editor"].trigger("keyup");
                            }
                        }, render_delay);
                    }
                    // end render timer
                    // get source
                    var src = safe(g_state["el"]["c_editor"].val().replace(/\t/g, ""));
                    // prep
                    reset_control_flags();
                    // E V A L H A L L A
                    var survey_html = raise_src_to_evalhalla(src);
                    // load render
                    g_state["el"]["c_render"].html(form_wrap(survey_html));
                    // reinit submit, lang refresh
                    $("#evalhalla_submit").on("click", evalhalla_submit);
                    refresh_lang();
                    refresh_generics();
                    // pagination
                    $(".ev-page-sel").removeClass("active");
                    $(".ev-page-sel-" + g_control_flags["currpageid"]).addClass("active");

                    $(".ev-page").hide();
                    $(".ev-page-" + g_control_flags["currpageid"]).show();

                    $("#evalhalla_submit").addClass("disabled");
                    if (g_control_flags["currpageid"] == g_control_flags["pageid"]) {
                        $("#evalhalla_submit").removeClass("disabled");
                    }

                    for (var i = 1; i <= g_control_flags["pageid"]; i++) {
                        $(".ev-page-sel-" + i).on("click", { "i": i },
                            function (e) {
                                g_control_flags["currpageid"] = e.data.i
                                $(".ev-page").hide();
                                $(".ev-page-" + e.data.i).show();
                                $(".ev-page-sel").removeClass("active");
                                $(".ev-page-sel-" + e.data.i).addClass("active");
                                $(".determinate").css({ "width": ((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + "%" });
                                $(".determinate-text").text(((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + "%");
                                //alert(e.data.i);
                                $("#evalhalla_submit").addClass("disabled");
                                window.scrollTo(0, 0);
                                if (g_control_flags["currpageid"] == g_control_flags["pageid"]) {
                                    $("#evalhalla_submit").removeClass("disabled");
                                }
                            });
                    }
                    $(".ev-page-sel-" + "left").on("click", { "i": "left" },
                        function (e) {
                            g_control_flags["currpageid"] = g_control_flags["currpageid"] - 1;
                            if (g_control_flags["currpageid"] <= 0) {
                                g_control_flags["currpageid"] = 1;
                            }
                            $(".ev-page").hide();
                            $(".ev-page-" + g_control_flags["currpageid"]).show();
                            $(".ev-page-sel").removeClass("active");
                            $(".ev-page-sel-" + g_control_flags["currpageid"]).addClass("active");
                            $(".determinate").css({ "width": ((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + "%" });
                            $(".determinate-text").text(((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + "%");


                            //alert(e.data.i);
                            $("#evalhalla_submit").addClass("disabled");
                            window.scrollTo(0, 0);
                            if (g_control_flags["currpageid"] == g_control_flags["pageid"]) {
                                $("#evalhalla_submit").removeClass("disabled");
                            }
                        });
                    $(".ev-page-sel-" + "right").on("click", { "i": "right" },
                        function (e) {
                            //alert(e.data.i);
                            g_control_flags["currpageid"] = g_control_flags["currpageid"] + 1;
                            if (g_control_flags["currpageid"] >= g_control_flags["pageid"]) {
                                g_control_flags["currpageid"] = g_control_flags["pageid"];
                            }
                            $(".ev-page").hide();
                            $(".ev-page-" + g_control_flags["currpageid"]).show();
                            $(".ev-page-sel").removeClass("active");
                            $(".ev-page-sel-" + g_control_flags["currpageid"]).addClass("active");
                            $(".determinate").css({ "width": ((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + "%" });
                            $(".determinate-text").text(((parseFloat(g_control_flags["currpageid"]) / parseFloat(g_control_flags["pageid"])) * 100).toFixed(0) + "%");

                            //alert(e.data.i);
                            $("#evalhalla_submit").addClass("disabled");
                            window.scrollTo(0, 0);
                            if (g_control_flags["currpageid"] == g_control_flags["pageid"]) {
                                $("#evalhalla_submit").removeClass("disabled");
                            }
                        });

                    // load json
                    try {
                        g_state["el"]["c_json"].val(JSON.stringify(JSON.parse(
                            g_control_flags["json"]
                                .replace(/\,\%questions/g, "")
                                .replace(/\%options/g, "")
                                .replace(/\%questions/g, "")
                        ), null, 4));
                    } catch (e) {
                        M.toast({ html: 'Hint: Use single quotes, JSON ' + e.toString(), classes: 'rounded' });
                    }
                    // todo: accessibility check on materialize dropdown (there's shadow elements causing label issues)
                    //$('select').formSelect();

                });
                // render
                g_state["el"]["c_editor"].trigger("change");
                // resize
                ui_resize_textareas();

                // upload to survista: stub
                // TODO: Fix with correct code (right now just obj/deobj for test)
                g_state["el"]["btn_upload"].on("click", function () {
                    alert(
                        JSON.stringify(JSON.parse(
                            g_control_flags["json"]
                                .replace(/\,\%questions/g, "")
                                .replace(/\%questions/g, "")
                                .replace(/\%options/g, "")
                        ), null, 4)
                    );
                });

                // Local storage
                g_state["el"]["adm_clear_ls"].on("click", function () {
                    alert("Clearing LocalStorage...");
                    ls_clear_saved_entries();
                    g_state["el"]["c_ls"].val("");
                });

                g_state["el"]["adm_save_working_survey"].on("click", function () {
                    alert("Saving Working Survey...");
                    ls_save_survey_signature(g_control_flags["json"]
                        .replace(/\,\%questions/g, "")
                        .replace(/\%questions/g, "")
                        .replace(/\%options/g, ""), safe(g_state["el"]["c_editor"].val()));
                });

                //
                // UI Hide Show
                //

                ui_reset_panels = function () {
                    g_state["el"]["ui_render"].addClass("m6").removeClass("m12");
                    g_state["el"]["ui_render"].show();
                    g_state["el"]["ui_editor"].addClass("m6").removeClass("m12");
                    g_state["el"]["ui_editor"].show();
                    g_state["el"]["ui_json"].addClass("m6").removeClass("m12");
                    g_state["el"]["ui_json"].hide();
                    // g_state["el"]["ui_ls"].addClass("m4").removeClass("m12");
                    g_state["el"]["ui_ls"].show();
                    g_state["el"]["ui_qlib"].show();
                    g_state["ui"]["hs_render_window"] = false;
                    g_state["ui"]["hs_editor_window"] = false;
                    g_state["ui"]["hs_json_window"] = false;
                    g_state["ui"]["hs_ls_window"] = false;
                    g_state["ui"]["hs_qlib_window"] = false;
                };
                g_state["el"]["btn_hs_qlib"].on("click", function () {
                    if (g_state["ui"]["hs_qlib_window"] == true) {
                        ui_reset_panels();
                    } else {
                        //g_state["el"]["ui_ls"].removeClass("m4").addClass("m12");
                        g_state["el"]["ui_qlib"].show();
                        g_state["el"]["ui_ls"].hide();
                        g_state["el"]["ui_render"].hide();
                        g_state["el"]["ui_editor"].hide();
                        g_state["el"]["ui_json"].hide();
                        g_state["ui"]["hs_qlib_window"] = true;
                    }
                });
                g_state["el"]["btn_hs_ls"].on("click", function () {
                    if (g_state["ui"]["hs_ls_window"] == true) {
                        ui_reset_panels();
                    } else {
                        //g_state["el"]["ui_ls"].removeClass("m4").addClass("m12");
                        g_state["el"]["ui_ls"].show();
                        g_state["el"]["ui_render"].hide();
                        g_state["el"]["ui_editor"].hide();
                        g_state["el"]["ui_json"].hide();
                        g_state["el"]["ui_qlib"].hide();
                        g_state["ui"]["hs_ls_window"] = true;
                    }
                });
                g_state["el"]["btn_hs_render"].on("click", function () {
                    if (g_state["ui"]["hs_render_window"] == true) {
                        ui_reset_panels();
                    } else {
                        g_state["el"]["ui_render"].removeClass("m6").addClass("m12");
                        g_state["el"]["ui_render"].show();
                        g_state["el"]["ui_editor"].hide();
                        g_state["el"]["ui_json"].hide();
                        g_state["el"]["ui_ls"].hide();
                        g_state["el"]["ui_qlib"].hide();
                        g_state["ui"]["hs_render_window"] = true;
                    }
                });
                g_state["el"]["btn_hs_editor"].on("click", function () {
                    if (g_state["ui"]["hs_editor_window"] == true) {
                        ui_reset_panels();
                    } else {
                        g_state["el"]["ui_editor"].removeClass("m6").addClass("m12");
                        g_state["el"]["ui_editor"].show();
                        g_state["el"]["ui_json"].hide();
                        g_state["el"]["ui_render"].hide();
                        g_state["el"]["ui_ls"].hide();
                        g_state["el"]["ui_qlib"].hide();
                        g_state["ui"]["hs_editor_window"] = true;
                    }
                });
                g_state["el"]["btn_hs_json"].on("click", function () {
                    if (g_state["ui"]["hs_json_window"] == true) {
                        ui_reset_panels();
                    } else {
                        g_state["el"]["c_json"].val(JSON.stringify(JSON.parse(g_control_flags["json"]
                            .replace(/\,\%questions/g, "")
                            .replace(/\%options/g, "")
                        ), null, 4));
                        //g_state["el"]["ui_json"].removeClass("m6").addClass("m12");
                        g_state["el"]["ui_json"].show();
                        g_state["el"]["ui_editor"].hide();
                        g_state["el"]["ui_render"].hide();
                        g_state["el"]["ui_ls"].hide();
                        g_state["el"]["ui_qlib"].hide();
                        g_state["ui"]["hs_json_window"] = true;
                    }
                });
                g_state["el"]["btn_audit"].on("click", function () {
                    alert("Auditing Evalhalla to Survista Render. Note there may be differences until both systems are fully aligned.");
                    audit_json();
                });

                //
                // Editor buttons
                //
                var get_editor_tmpl = function (cmd) {
                    if (cmd == "header") {
                        return "# 1234\n## Survey Title\n### Survey introduction text\n\n";
                    } else if (cmd == "instr") {
                        return "// Explanatory text note\n\n";
                    } else if (cmd == "qany") {
                        return "Q: This is my question?\n/any\nOption\nOption\nOption\n;\n\n";
                    } else if (cmd == "qfree") {
                        return "Q: This is my question?\n/open\n\n";
                    } else if (cmd == "qone") {
                        return "Q: This is my question?\n/one\nOption\nOption\nOption\n;\n\n";
                    } else if (cmd == "qrank") {
                        return "Q: This is my question?\n/rank\nOption\nOption\nOption\n;\n\n";
                    } else if (cmd == "qscale") {
                        return "Q: This is my question?\n/scale Low, High, Unsure\n\n";
                    } else {
                        return "";
                    }
                }
                var editor_add_template = function (cmd) {
                    g_state["el"]["c_editor"].val(
                        safe(g_state["el"]["c_editor"].val()) + get_editor_tmpl(cmd)
                    );
                    g_state["el"]["c_editor"].trigger("keyup");
                }
                var trigger_action = function (curr_action) {
                    //console.log(curr_action);
                    editor_add_template(curr_action);
                };
                var enable_editor_buttons = function (actions) {
                    g_state["el"]["edt_" + "header"].on("click", function () { trigger_action("header"); });
                    g_state["el"]["edt_" + "instr"].on("click", function () { trigger_action("instr"); });
                    g_state["el"]["edt_" + "qany"].on("click", function () { trigger_action("qany"); });
                    g_state["el"]["edt_" + "qfree"].on("click", function () { trigger_action("qfree"); });
                    g_state["el"]["edt_" + "qone"].on("click", function () { trigger_action("qone"); });
                    g_state["el"]["edt_" + "qrank"].on("click", function () { trigger_action("qrank"); });
                    g_state["el"]["edt_" + "qscale"].on("click", function () { trigger_action("qscale"); });
                    //
                    g_state["el"]["edt_erase"].on("click", function () {
                        // probs should confirm here. TODO
                        g_state["el"]["c_editor"].val("");
                        g_state["el"]["c_editor"].trigger("keyup");
                    });
                };
                enable_editor_buttons();

                //
                // Tutorial runner setup
                //

                var run_type_it = function (type_this = "type_it_short") {
                    g_state["tut"]["char_at"] = 0;
                    g_state["el"]["c_editor"].val("");
                    reset_control_flags(true);
                    clearInterval(g_state["tut"]["typer"]);
                    g_state["tut"]["typer"] = null;
                    g_state["tut"]["typer"] = setInterval(function () {
                        if (g_state["tut"]["char_at"] > g_state["tut"]["" + type_this].length) {
                            clearInterval(g_state["tut"]["typer"]);
                            g_state["tut"]["typer"] = null;
                        } else {
                            try {
                                if (typeof g_state["tut"]["" + type_this][g_state["tut"]["char_at"]] !== "undefined") {
                                    g_state["el"]["c_editor"].val(
                                        g_state["el"]["c_editor"].val() + g_state["tut"]["" + type_this][g_state["tut"]["char_at"]]
                                    );
                                    g_state["el"]["c_editor"].trigger("keyup");
                                    g_state["tut"]["char_at"] = g_state["tut"]["char_at"] + 1;
                                    ui_resize_textareas();
                                }
                            } catch (e) {
                                // do nothing
                            }
                        }
                    }, 80);
                };

                g_state["el"]["btn_tutorial"].on("click", function () {
                    if (g_state["ui"]["lang"] == "en") {
                        run_type_it("type_it_short");
                    } else {
                        run_type_it("type_it_short_fr");
                    }
                });

                // 
                // JSON Render
                //

                var audit_json = function () {
                    var src = JSON.parse(
                        g_control_flags["json"]
                            .replace(/\,\%questions/g, "")
                            .replace(/\%options/g, "")
                    );
                    var render = [];

                    //alert(JSON.stringify(src));
                    var snip = get_template_snip("header");
                    snip = snip.replace(/\%title/g, src["title"]);
                    snip = snip.replace(/\%survey/g, src["language"]);
                    snip = snip.replace(/\%intro/g, src["description"]);
                    render.push(snip);

                    var qs = src["questions"];
                    for (var k = 0; k < qs.length; k++) {
                        qsnip = "";
                        if (qs[k]["questionType"] == "instruction") {
                            qsnip = get_template_snip("instruction");
                        } else {
                            qsnip = get_template_snip("question");
                        }

                        qsnip = qsnip.replace(/\%question/g, qs[k]["question"]);
                        qsnip = qsnip.replace(/\%instruction/g, qs[k]["question"]);
                        qsnip = qsnip.replace(/\%qid/g, qs[k]["qid"]);
                        //src["language"]
                        //src["randomOrder"] // TODO
                        //src["randomOptions"] // TODO
                        var opts = qs[k]["options"];
                        var render_opts = [];
                        var opts_snip = "";
                        if (qs[k]["questionType"] == "dropdown") {
                            opts_snip = get_template_snip("scale")
                                .replace(/\%qid/g, qs[k]["qid"])
                                .replace(/\%low/g, "Low")
                                .replace(/\%high/g, "High")
                                .replace(/\%unsure/g, "Unsure")
                                ;
                        } else if (qs[k]["questionType"] == "text") {
                            opts_snip = get_template_snip("open")
                                .replace(/\%qid/g, qs[k]["qid"])
                                ;
                        }
                        if (qs[k]["questionType"] == "mcq") {
                            for (var l = 0; l < opts.length; l++) {

                                opts_snip = get_template_snip("pick one");
                                //opts_snip = get_template_snip("pick any"); // survista handles it?
                                //opts_snip = get_template_snip("rank"); // survista handles it?

                                //console.log(qs[k]["questionType"]);
                                // render_opts.push(opts[l]);                          
                                opts_snip = opts_snip
                                    .replace(/\%qid/g, qs[k]["qid"])
                                    .replace(/\%pick/g, opts[l].trim())
                                    .replace(/\%oid/g, l)
                                    ;
                                render_opts.push(opts_snip);
                                //console.log(opts_snip);
                                //random_shuffle.push(opts_snip);
                            }
                        } else {
                            render_opts.push(opts_snip);
                        }

                        qsnip = qsnip.replace(/\%form/g, render_opts.join(""));
                        //snip = snip.replace(/\%form/g, qsnip);
                        render.push(qsnip);
                    }

                    render = form_wrap(render.join(""));
                    g_state["el"]["btn_hs_render"].trigger("click");
                    g_state["el"]["c_render"].html(render);
                    // reinit submit, lang refresh
                    refresh_lang();
                    $("#evalhalla_submit").on("click", evalhalla_submit);
                    $("select").formSelect();

                };

                //
                //  Auto Display Mode
                //

                if (auto_display_mode == true) {
                    //alert("auto");
                    g_state["el"]["ui_render"].removeClass("m6").addClass("m12");

                    $("#step_lang").show();
                    $("#step_offering").hide();
                    $("#step_tombstone").hide();
                    $("#step_thank_you_cta").hide();

                    g_state["el"]["ui_render"].hide();
                    g_state["el"]["ui_editor"].hide();
                    g_state["el"]["ui_json"].hide();
                    g_state["el"]["ui_ls"].hide();
                    g_state["el"]["ui_qlib"].hide();
                    $("#admin_footer").hide();
                    $("#admin_footer_end").hide();
                    $(".adm-function").hide();
                    g_state["ui"]["hs_render_window"] = true;
                    // HACK: hidden textareas have real height for some reason.
                    // adding display none kills resize capability of textarea.
                    // we're dynamically adding the maxsize when we need it in presentation mode
                    $(".hiddendiv").addClass("hiddendiv-maxsized");
                } else {
                    $("#step_lang").hide();
                    $("#step_offering").hide();
                    $("#step_tombstone").hide();
                    $("#step_thank_you_cta").hide();
                }

                //
                // MVP 0.1 Connection, Registhor
                //

                // Registhor Connection
                /*
                {
                    "results": [
                    {
                        "offering_id": 119472,
                        "course_code": "A313",
                        "course_title": "Fundamentals of Writing for the Web (A313)",
                        "offering_city": "NATIONAL CAPITAL REGION (NCR)",
                        "offering_province": "NCR/RCN"
                    },
                */
                var populate_offerings = function () {
                    var date = new Date();
                    var date_string = new Date(date.getTime() - (date.getTimezoneOffset() * 60000))
                        .toISOString()
                        .split("T")[0];
                    $.ajax({
                        url: api_get_offering_route.replace("%currentdate", date_string) + api_key,
                        contentType: "application/json",
                        type: "GET",
                        //data: data_in,
                        success: function (response) {
                            var offs = response.results ? response.results : [];
                            var offs_html = "";
                            var suggested = "";
                            // to enable testing when no courses load. delete this code
                            if (offs.length == 0) {
                                offs_html += "<h4><span class='en'>No courses today</span><span class='fr'>Aucune de cours aujourd'hui</span></h4>";
                                offs = [
                                    {
                                        "offering_id": 000000,
                                        "course_code": "X000",
                                        "course_title": "(dev) Test Course",
                                        "offering_city": "NATIONAL CAPITAL REGION (NCR)",
                                        "offering_province": "NCR/RCN"
                                    }];
                            }
                            // end delete
                            for (var i = 0; i < offs.length; i++) {
                                if (i == 0) {
                                    suggested = `<div style="padding: 1em;">
                                        <span class="badge red white-text" style="float:none;">
                                            <span class="en">Suggested</span><span class="fr">Suggéré</span>
                                        </span></div>
                                        `
                                } else {
                                    suggested = "";
                                }
                                offs_html += `<div class="card-panel purp-canada-ca-edged">
                                    <div class="padbox">
                                        ${suggested}
                                        <div class="row">
                                    ${offs[i]["offering_id"]} - ${offs[i]["course_code"]}<br />
                                    <strong>${offs[i]["course_title"]}</strong><br />
                                    ${offs[i]["offering_city"]}, ${offs[i]["offering_province"]}
                                    </div><div class="row">
                                    <button id="off_${offs[i]["offering_id"]}" class="select-offering btn purp-canada-ca"><span class="en">Select</span><span class="fr">Choisir</span></button>
                                    </div></div></div>`;

                            }
                            g_state["tombstone"]["offerings"] = offs;

                            $(".offering_target").html(offs_html);
                            refresh_lang();
                            $(".select-offering").on("click", function () {
                                //alert($(this).attr("id").split("_")[1]);
                                g_state["tombstone"]["offering_id"] = $(this).attr("id").split("_")[1];
                                for (var i = 0; i < g_state["tombstone"]["offerings"].length; i++) {
                                    if (g_state["tombstone"]["offering_id"] == g_state["tombstone"]["offerings"][i]["offering_id"]) {
                                        $("#autocomplete-input-city").val(
                                            g_state["tombstone"]["offerings"][i]["offering_city"]
                                        );
                                        M.updateTextFields();
                                    }
                                }

                                $("#step_offering").hide();
                                $("#step_tombstone").show();
                            });
                        }
                    });
                }
                populate_offerings();

            });
        })(jQuery);
    </script>
</body>

</html>